<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma Analytics - 注专转 转 住砖</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #EC4899;
            --bg-dark: #0F0F1A;
            --bg-card: #1A1A2E;
            --bg-input: #252542;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0B2;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .emma-quote {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 10px;
            margin-top: 15px;
            font-style: italic;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            background: var(--bg-card);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .tab:hover {
            background: var(--bg-input);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        /* Stats Cards */
        .stat-card {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--bg-input);
        }

        th {
            background: var(--bg-input);
            color: var(--text-secondary);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .platform-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .platform-instagram {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            color: white;
        }

        .platform-tiktok {
            background: #000;
            color: white;
        }

        .platform-youtube {
            background: #FF0000;
            color: white;
        }

        .platform-twitter {
            background: #1DA1F2;
            color: white;
        }

        .status-active {
            color: var(--success);
        }

        .status-inactive {
            color: var(--text-secondary);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Emma Report */
        .emma-report {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .emma-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-left: 15px;
        }

        .emma-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .emma-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .emma-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .emma-content {
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* API Panel */
        .api-endpoint {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .json-input {
            font-family: monospace;
            min-height: 200px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: var(--success);
        }

        .toast-error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-input);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-4 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }

        /* Highlight row */
        .highlight-row {
            background: rgba(139, 92, 246, 0.2) !important;
        }

        /* Gemini API Key Input */
        .api-key-section {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
        }

        .api-key-input input {
            flex: 1;
        }

        /* Search */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 15px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
        }

        /* Performance indicator */
        .performance {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .performance-bar {
            height: 8px;
            border-radius: 4px;
            background: var(--bg-input);
            flex: 1;
            max-width: 100px;
            overflow: hidden;
        }

        .performance-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .perf-high { background: var(--success); }
        .perf-medium { background: var(--warning); }
        .perf-low { background: var(--danger); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Emma Analytics</h1>
            <p>注专转 转 住砖 专 拽 砖  专</p>
            <div class="emma-quote">
                "转 转       注   拽砖 砖 拽, 砖  爪专   砖."
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-panel="dashboard">砖专</button>
            <button class="tab" data-panel="creators">爪专 转</button>
            <button class="tab" data-panel="stats">住住拽转 转</button>
            <button class="tab" data-panel="posts">驻住</button>
            <button class="tab" data-panel="api">API / Webhook</button>
            <button class="tab" data-panel="report">" </button>
        </div>

        <!-- Dashboard Panel -->
        <div id="dashboard" class="panel active">
            <div class="grid-4">
                <div class="stat-card">
                    <div class="stat-value" id="totalCreators">0</div>
                    <div class="stat-label">爪专 转</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalFollowers">0</div>
                    <div class="stat-label">住" 注拽</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalViews">0</div>
                    <div class="stat-label">爪驻转 </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPosts">0</div>
                    <div class="stat-label">驻住 注拽</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">爪转 注拽 - 7  专</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="followersChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">爪驻转 驻 驻驻专</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="platformChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">驻 5 驻住 </h3>
                </div>
                <div class="table-container">
                    <table id="topPostsTable">
                        <thead>
                            <tr>
                                <th>爪专</th>
                                <th>驻驻专</th>
                                <th>转专</th>
                                <th>爪驻转</th>
                                <th>拽</th>
                                <th>转转</th>
                                <th>爪注</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Creators Panel -->
        <div id="creators" class="panel">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"> 爪专 转</h3>
                    <button class="btn btn-primary" onclick="openAddCreatorModal()">+ 住祝 爪专</button>
                </div>
                <div class="search-box">
                    <input type="text" id="creatorSearch" placeholder="驻砖 爪专..." oninput="filterCreators()">
                    <select id="platformFilter" onchange="filterCreators()">
                        <option value=""> 驻驻专转</option>
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube</option>
                        <option value="twitter">Twitter/X</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="creatorsTable">
                        <thead>
                            <tr>
                                <th>砖</th>
                                <th>Handle</th>
                                <th>驻驻专</th>
                                <th>拽专</th>
                                <th>住住</th>
                                <th>注拽</th>
                                <th>驻注转</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div id="stats" class="panel">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">住驻转 住住拽转 转</h3>
                </div>
                <form id="statsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>爪专</label>
                            <select id="statsCreatorId" required>
                                <option value="">专 爪专...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>转专</label>
                            <input type="date" id="statsDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>住驻专 注拽</label>
                            <input type="number" id="statsFollowers" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>住驻专 驻住</label>
                            <input type="number" id="statsPostsCount" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>爪驻转 </label>
                            <input type="number" id="statsViews" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>拽 </label>
                            <input type="number" id="statsLikes" placeholder="0">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">砖专 住住拽转</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">住专转 住住拽转</h3>
                    <select id="statsHistoryCreator" onchange="loadStatsHistory()">
                        <option value=""> 爪专</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>爪专</th>
                                <th>转专</th>
                                <th>注拽</th>
                                <th>驻住</th>
                                <th>爪驻转</th>
                                <th>拽</th>
                                <th>爪</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card" id="creatorChartCard" style="display:none;">
                <div class="card-header">
                    <h3 class="card-title">专祝 爪 - <span id="chartCreatorName"></span></h3>
                </div>
                <div class="chart-container">
                    <canvas id="creatorGrowthChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Posts Panel -->
        <div id="posts" class="panel">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">住驻转 驻住</h3>
                </div>
                <form id="postForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>爪专</label>
                            <select id="postCreatorId" required>
                                <option value="">专 爪专...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>转专</label>
                            <input type="date" id="postDate" required>
                        </div>
                        <div class="form-group">
                            <label> 驻住 驻驻专</label>
                            <input type="text" id="postPlatformId" placeholder="ID">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>拽砖专 驻住</label>
                        <input type="url" id="postUrl" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>转专 / Caption</label>
                        <textarea id="postCaption" rows="3" placeholder="转 驻住..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>爪驻转</label>
                            <input type="number" id="postViews" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>拽</label>
                            <input type="number" id="postLikes" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>转转</label>
                            <input type="number" id="postComments" placeholder="0">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">砖专 驻住</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"> 驻住</h3>
                    <div>
                        <select id="postsCreatorFilter" onchange="loadPosts()">
                            <option value=""> 爪专</option>
                        </select>
                        <select id="postsSortBy" onchange="loadPosts()">
                            <option value="views"> 驻 爪驻转</option>
                            <option value="likes"> 驻 拽</option>
                            <option value="comments"> 驻 转转</option>
                            <option value="date"> 驻 转专</option>
                            <option value="engagement"> 驻 '</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table id="postsTable">
                        <thead>
                            <tr>
                                <th>爪专</th>
                                <th>转专</th>
                                <th>转专</th>
                                <th>爪驻转</th>
                                <th>拽</th>
                                <th>转转</th>
                                <th>'</th>
                                <th>驻注转</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- API Panel -->
        <div id="api" class="panel">
            <!-- Google Sheets Integration -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"> 专 -Google Sheets</h3>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    专 转 砖专 -Google Sheets 拽转 转 转. 拽 转 转转 -Web App 住拽专驻.
                </p>
                <div class="api-key-section">
                    <label style="margin-bottom: 10px; display: block;">转转 Google Apps Script Web App</label>
                    <div class="api-key-input">
                        <input type="text" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/xxx/exec">
                        <button class="btn btn-primary" onclick="saveGoogleSheetsUrl()">砖专</button>
                    </div>
                    <small style="color: var(--text-secondary); margin-top: 10px; display: block;">
                         <a href="emma-google-apps-script.js" target="_blank" style="color: var(--primary);">专 转 住拽专驻</a> 转拽 -Google Sheets
                    </small>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="syncFromGoogleSheets()">
                         住专 注砖
                    </button>
                    <button class="btn btn-secondary" onclick="testGoogleSheetsConnection()">
                        И 拽 专
                    </button>
                    <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                        <input type="checkbox" id="autoSync" onchange="toggleAutoSync()"> 住专  注
                    </label>
                </div>
                <div id="syncStatus" style="margin-top: 15px; display: none;" class="emma-report">
                    <div id="syncStatusContent"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">API / Webhook Endpoint</h3>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    砖转砖 -endpoint  砖转 转  注专转. 转 专  住拽专驻   爪.
                </p>
                <div class="api-endpoint">
                    POST /api/data<br>
                    Content-Type: application/json
                </div>

                <h4 style="margin: 20px 0 10px;">驻专 JSON :</h4>
                <textarea id="jsonExample" class="form-group json-input" readonly>{
  "type": "daily_stats",
  "data": {
    "creatorHandle": "@example",
    "platform": "instagram",
    "date": "2026-01-16",
    "followersCount": 150000,
    "postsCount": 342,
    "viewsToday": 50000,
    "likesToday": 12000
  }
}

//  驻住 :
{
  "type": "post",
  "data": {
    "creatorHandle": "@example",
    "platform": "instagram",
    "date": "2026-01-16",
    "platformPostId": "abc123",
    "url": "https://instagram.com/p/abc123",
    "caption": "驻住 ...",
    "views": 100000,
    "likes": 8500,
    "comments": 450
  }
}</textarea>

                <h4 style="margin: 20px 0 10px;">拽转 API -  JSON:</h4>
                <form id="apiTestForm">
                    <textarea id="apiTestInput" class="form-group json-input" placeholder="拽 JSON ..."></textarea>
                    <button type="submit" class="btn btn-primary">砖 转</button>
                </form>

                <div id="apiResponse" style="margin-top: 15px; display: none;">
                    <h4>转砖:</h4>
                    <pre id="apiResponseContent" class="api-endpoint"></pre>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">爪 转</h3>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportData('creators')">爪 爪专 (JSON)</button>
                    <button class="btn btn-secondary" onclick="exportData('stats')">爪 住住拽转 (JSON)</button>
                    <button class="btn btn-secondary" onclick="exportData('posts')">爪 驻住 (JSON)</button>
                    <button class="btn btn-secondary" onclick="exportData('all')">爪  (JSON)</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"> 转</h3>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"> 拽抓 JSON</button>
            </div>
        </div>

        <!-- Report Panel -->
        <div id="report" class="panel">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">专转 AI</h3>
                </div>
                <div class="api-key-section">
                    <label style="margin-bottom: 10px; display: block;">驻转 Gemini API (" )</label>
                    <div class="api-key-input">
                        <input type="password" id="geminiApiKey" placeholder=" 转 驻转 -API 砖 Gemini">
                        <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()">爪</button>
                        <button class="btn btn-primary" onclick="saveApiKey()">砖专</button>
                    </div>
                    <small style="color: var(--text-secondary); margin-top: 10px; display: block;">
                        拽 驻转  : <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--primary);">Google AI Studio</a>
                    </small>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">爪专 "  </h3>
                    <button class="btn btn-primary" onclick="generateEmmaReport()">爪专 " 拽 砖 </button>
                </div>

                <div id="reportLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p> 转转 转 转...</p>
                </div>

                <div id="emmaReportContainer" style="display: none;">
                    <div class="emma-report">
                        <div class="emma-header">
                            <div class="emma-avatar">AI</div>
                            <div>
                                <div class="emma-name"> 专</div>
                                <div class="emma-title">-砖驻注转 砖</div>
                            </div>
                        </div>
                        <div class="emma-content" id="emmaReportContent"></div>
                    </div>
                </div>

                <div id="noDataMessage" class="emma-report" style="display: none;">
                    <p> 住驻拽 转 爪专转 ". 住驻 爪专 转 住住拽转 转.</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">住专转 "转</h3>
                </div>
                <div id="reportsHistory">
                    <p style="color: var(--text-secondary);">"转 砖爪专 驻注 ...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Creator Modal -->
    <div id="creatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="creatorModalTitle">住驻转 爪专 转</h3>
                <button class="close-btn" onclick="closeCreatorModal()">&times;</button>
            </div>
            <form id="creatorForm">
                <input type="hidden" id="creatorId">
                <div class="form-group">
                    <label>砖</label>
                    <input type="text" id="creatorName" placeholder="砖 爪专" required>
                </div>
                <div class="form-group">
                    <label>Handle</label>
                    <input type="text" id="creatorHandle" placeholder="@username" required>
                </div>
                <div class="form-group">
                    <label>驻驻专</label>
                    <select id="creatorPlatform" required>
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube</option>
                        <option value="twitter">Twitter/X</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>拽专</label>
                    <input type="text" id="creatorCategory" placeholder="驻, 驻住, ...">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="creatorActive" checked> 驻注
                    </label>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">砖专</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreatorModal()"></button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database using localStorage
        const DB = {
            get(key) {
                const data = localStorage.getItem(`emma_${key}`);
                return data ? JSON.parse(data) : [];
            },
            set(key, data) {
                localStorage.setItem(`emma_${key}`, JSON.stringify(data));
            },
            getSettings() {
                const data = localStorage.getItem('emma_settings');
                return data ? JSON.parse(data) : {};
            },
            setSettings(settings) {
                localStorage.setItem('emma_settings', JSON.stringify(settings));
            }
        };

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Format numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        // ============ CREATORS ============
        function loadCreators() {
            const creators = DB.get('creators');
            const stats = DB.get('dailyStats');
            const tbody = document.querySelector('#creatorsTable tbody');
            tbody.innerHTML = '';

            creators.forEach(creator => {
                // Get latest follower count
                const creatorStats = stats.filter(s => s.creatorId === creator.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                const latestFollowers = creatorStats[0]?.followersCount || 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${creator.name}</td>
                    <td>${creator.handle}</td>
                    <td><span class="platform-badge platform-${creator.platform}">${creator.platform}</span></td>
                    <td>${creator.category || '-'}</td>
                    <td class="${creator.isActive ? 'status-active' : 'status-inactive'}">${creator.isActive ? '驻注' : ' 驻注'}</td>
                    <td>${formatNumber(latestFollowers)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCreator('${creator.id}')">注专</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCreator('${creator.id}')">拽</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update dropdowns
            updateCreatorDropdowns(creators);
            updateDashboard();
        }

        function updateCreatorDropdowns(creators) {
            const selects = [
                document.getElementById('statsCreatorId'),
                document.getElementById('postCreatorId'),
                document.getElementById('statsHistoryCreator'),
                document.getElementById('postsCreatorFilter')
            ];

            selects.forEach((select, index) => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = index >= 2 ? '<option value=""> 爪专</option>' : '<option value="">专 爪专...</option>';
                creators.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name} (${c.handle})</option>`;
                });
                select.value = currentValue;
            });
        }

        function openAddCreatorModal() {
            document.getElementById('creatorModalTitle').textContent = '住驻转 爪专 转';
            document.getElementById('creatorForm').reset();
            document.getElementById('creatorId').value = '';
            document.getElementById('creatorModal').classList.add('active');
        }

        function closeCreatorModal() {
            document.getElementById('creatorModal').classList.remove('active');
        }

        function editCreator(id) {
            const creators = DB.get('creators');
            const creator = creators.find(c => c.id === id);
            if (!creator) return;

            document.getElementById('creatorModalTitle').textContent = '注专转 爪专 转';
            document.getElementById('creatorId').value = creator.id;
            document.getElementById('creatorName').value = creator.name;
            document.getElementById('creatorHandle').value = creator.handle;
            document.getElementById('creatorPlatform').value = creator.platform;
            document.getElementById('creatorCategory').value = creator.category || '';
            document.getElementById('creatorActive').checked = creator.isActive;
            document.getElementById('creatorModal').classList.add('active');
        }

        function deleteCreator(id) {
            if (!confirm(' 拽 转 爪专? 驻注 转拽  转  住住拽转 驻住 砖.')) return;

            let creators = DB.get('creators');
            let stats = DB.get('dailyStats');
            let posts = DB.get('posts');

            creators = creators.filter(c => c.id !== id);
            stats = stats.filter(s => s.creatorId !== id);
            posts = posts.filter(p => p.creatorId !== id);

            DB.set('creators', creators);
            DB.set('dailyStats', stats);
            DB.set('posts', posts);

            loadCreators();
            loadStatsHistory();
            loadPosts();
            showToast('爪专 拽 爪');
        }

        document.getElementById('creatorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const creators = DB.get('creators');
            const id = document.getElementById('creatorId').value;

            const creatorData = {
                name: document.getElementById('creatorName').value,
                handle: document.getElementById('creatorHandle').value,
                platform: document.getElementById('creatorPlatform').value,
                category: document.getElementById('creatorCategory').value,
                isActive: document.getElementById('creatorActive').checked
            };

            if (id) {
                const index = creators.findIndex(c => c.id === id);
                creators[index] = { ...creators[index], ...creatorData };
            } else {
                creatorData.id = generateId();
                creators.push(creatorData);
            }

            DB.set('creators', creators);
            closeCreatorModal();
            loadCreators();
            showToast(id ? '爪专 注' : '爪专 住祝 爪');
        });

        function filterCreators() {
            const search = document.getElementById('creatorSearch').value.toLowerCase();
            const platform = document.getElementById('platformFilter').value;
            const rows = document.querySelectorAll('#creatorsTable tbody tr');

            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const handle = row.cells[1].textContent.toLowerCase();
                const rowPlatform = row.cells[2].textContent.toLowerCase();

                const matchesSearch = name.includes(search) || handle.includes(search);
                const matchesPlatform = !platform || rowPlatform.includes(platform);

                row.style.display = matchesSearch && matchesPlatform ? '' : 'none';
            });
        }

        // ============ DAILY STATS ============
        document.getElementById('statsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const stats = DB.get('dailyStats');

            const statData = {
                id: generateId(),
                creatorId: document.getElementById('statsCreatorId').value,
                date: document.getElementById('statsDate').value,
                followersCount: parseInt(document.getElementById('statsFollowers').value) || 0,
                postsCount: parseInt(document.getElementById('statsPostsCount').value) || 0,
                viewsToday: parseInt(document.getElementById('statsViews').value) || 0,
                likesToday: parseInt(document.getElementById('statsLikes').value) || 0
            };

            stats.push(statData);
            DB.set('dailyStats', stats);
            document.getElementById('statsForm').reset();
            document.getElementById('statsDate').value = new Date().toISOString().split('T')[0];
            loadStatsHistory();
            loadCreators();
            showToast('住住拽转 砖专');
        });

        function loadStatsHistory() {
            const stats = DB.get('dailyStats');
            const creators = DB.get('creators');
            const creatorFilter = document.getElementById('statsHistoryCreator').value;

            let filteredStats = creatorFilter
                ? stats.filter(s => s.creatorId === creatorFilter)
                : stats;

            filteredStats.sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.querySelector('#statsTable tbody');
            tbody.innerHTML = '';

            filteredStats.slice(0, 50).forEach((stat, index) => {
                const creator = creators.find(c => c.id === stat.creatorId);

                // Calculate growth
                const prevStat = filteredStats.find((s, i) =>
                    i > index && s.creatorId === stat.creatorId
                );
                const growth = prevStat
                    ? stat.followersCount - prevStat.followersCount
                    : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${creator?.name || ' 注'}</td>
                    <td>${stat.date}</td>
                    <td>${formatNumber(stat.followersCount)}</td>
                    <td>${stat.postsCount}</td>
                    <td>${formatNumber(stat.viewsToday)}</td>
                    <td>${formatNumber(stat.likesToday)}</td>
                    <td style="color: ${growth >= 0 ? 'var(--success)' : 'var(--danger)'}">
                        ${growth >= 0 ? '+' : ''}${formatNumber(growth)}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Show chart if creator is selected
            if (creatorFilter) {
                showCreatorGrowthChart(creatorFilter);
            } else {
                document.getElementById('creatorChartCard').style.display = 'none';
            }
        }

        function showCreatorGrowthChart(creatorId) {
            const stats = DB.get('dailyStats').filter(s => s.creatorId === creatorId);
            const creator = DB.get('creators').find(c => c.id === creatorId);

            if (stats.length < 2) {
                document.getElementById('creatorChartCard').style.display = 'none';
                return;
            }

            stats.sort((a, b) => new Date(a.date) - new Date(b.date));

            document.getElementById('creatorChartCard').style.display = 'block';
            document.getElementById('chartCreatorName').textContent = creator?.name || '';

            const ctx = document.getElementById('creatorGrowthChart').getContext('2d');

            if (window.creatorGrowthChartInstance) {
                window.creatorGrowthChartInstance.destroy();
            }

            window.creatorGrowthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stats.map(s => s.date),
                    datasets: [{
                        label: '注拽',
                        data: stats.map(s => s.followersCount),
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#A0A0B2' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#A0A0B2' }
                        }
                    }
                }
            });
        }

        // ============ POSTS ============
        document.getElementById('postForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const posts = DB.get('posts');

            const postData = {
                id: generateId(),
                creatorId: document.getElementById('postCreatorId').value,
                date: document.getElementById('postDate').value,
                platformPostId: document.getElementById('postPlatformId').value,
                url: document.getElementById('postUrl').value,
                caption: document.getElementById('postCaption').value,
                views: parseInt(document.getElementById('postViews').value) || 0,
                likes: parseInt(document.getElementById('postLikes').value) || 0,
                comments: parseInt(document.getElementById('postComments').value) || 0
            };

            posts.push(postData);
            DB.set('posts', posts);
            document.getElementById('postForm').reset();
            document.getElementById('postDate').value = new Date().toISOString().split('T')[0];
            loadPosts();
            showToast('驻住 砖专');
        });

        function loadPosts() {
            const posts = DB.get('posts');
            const creators = DB.get('creators');
            const creatorFilter = document.getElementById('postsCreatorFilter').value;
            const sortBy = document.getElementById('postsSortBy').value;

            let filteredPosts = creatorFilter
                ? posts.filter(p => p.creatorId === creatorFilter)
                : posts;

            // Calculate engagement and sort
            filteredPosts = filteredPosts.map(p => ({
                ...p,
                engagement: p.views > 0 ? ((p.likes + p.comments) / p.views * 100) : 0
            }));

            filteredPosts.sort((a, b) => {
                switch(sortBy) {
                    case 'views': return b.views - a.views;
                    case 'likes': return b.likes - a.likes;
                    case 'comments': return b.comments - a.comments;
                    case 'date': return new Date(b.date) - new Date(a.date);
                    case 'engagement': return b.engagement - a.engagement;
                    default: return b.views - a.views;
                }
            });

            const tbody = document.querySelector('#postsTable tbody');
            tbody.innerHTML = '';

            const maxViews = Math.max(...filteredPosts.map(p => p.views), 1);

            filteredPosts.forEach(post => {
                const creator = creators.find(c => c.id === post.creatorId);
                const perfPercent = (post.views / maxViews) * 100;
                let perfClass = 'perf-low';
                if (perfPercent > 66) perfClass = 'perf-high';
                else if (perfPercent > 33) perfClass = 'perf-medium';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${creator?.name || ' 注'}</td>
                    <td>${post.date}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.caption || '-'}</td>
                    <td>${formatNumber(post.views)}</td>
                    <td>${formatNumber(post.likes)}</td>
                    <td>${formatNumber(post.comments)}</td>
                    <td>${post.engagement.toFixed(2)}%</td>
                    <td>
                        ${post.url ? `<a href="${post.url}" target="_blank" class="btn btn-sm btn-secondary">爪驻</a>` : '-'}
                        <button class="btn btn-sm btn-danger" onclick="deletePost('${post.id}')">拽</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updateDashboard();
        }

        function deletePost(id) {
            if (!confirm(' 拽 转 驻住?')) return;
            let posts = DB.get('posts');
            posts = posts.filter(p => p.id !== id);
            DB.set('posts', posts);
            loadPosts();
            showToast('驻住 拽');
        }

        // ============ DASHBOARD ============
        function updateDashboard() {
            const creators = DB.get('creators');
            const stats = DB.get('dailyStats');
            const posts = DB.get('posts');

            // Stats cards
            document.getElementById('totalCreators').textContent = creators.length;
            document.getElementById('totalPosts').textContent = posts.length;

            // Calculate total followers (latest for each creator)
            let totalFollowers = 0;
            let totalViews = 0;
            creators.forEach(creator => {
                const creatorStats = stats.filter(s => s.creatorId === creator.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                if (creatorStats[0]) {
                    totalFollowers += creatorStats[0].followersCount;
                    totalViews += creatorStats[0].viewsToday;
                }
            });

            document.getElementById('totalFollowers').textContent = formatNumber(totalFollowers);
            document.getElementById('totalViews').textContent = formatNumber(totalViews);

            // Update charts
            updateFollowersChart();
            updatePlatformChart();
            updateTopPostsTable();
        }

        let followersChartInstance = null;
        let platformChartInstance = null;

        function updateFollowersChart() {
            const stats = DB.get('dailyStats');
            const creators = DB.get('creators');

            // Get last 7 days
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }

            // Aggregate followers per day
            const dailyTotals = dates.map(date => {
                let total = 0;
                creators.forEach(creator => {
                    const stat = stats
                        .filter(s => s.creatorId === creator.id && s.date <= date)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    if (stat) total += stat.followersCount;
                });
                return total;
            });

            const ctx = document.getElementById('followersChart').getContext('2d');

            if (followersChartInstance) {
                followersChartInstance.destroy();
            }

            followersChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.slice(5)),
                    datasets: [{
                        label: '住" 注拽',
                        data: dailyTotals,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#A0A0B2' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#A0A0B2' }
                        }
                    }
                }
            });
        }

        function updatePlatformChart() {
            const stats = DB.get('dailyStats');
            const creators = DB.get('creators');

            const platformViews = {
                instagram: 0,
                tiktok: 0,
                youtube: 0,
                twitter: 0
            };

            creators.forEach(creator => {
                const latestStat = stats
                    .filter(s => s.creatorId === creator.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                if (latestStat) {
                    platformViews[creator.platform] = (platformViews[creator.platform] || 0) + latestStat.viewsToday;
                }
            });

            const ctx = document.getElementById('platformChart').getContext('2d');

            if (platformChartInstance) {
                platformChartInstance.destroy();
            }

            platformChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Instagram', 'TikTok', 'YouTube', 'Twitter/X'],
                    datasets: [{
                        data: Object.values(platformViews),
                        backgroundColor: [
                            '#E1306C',
                            '#000000',
                            '#FF0000',
                            '#1DA1F2'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#A0A0B2' }
                        }
                    }
                }
            });
        }

        function updateTopPostsTable() {
            const posts = DB.get('posts');
            const creators = DB.get('creators');

            const sortedPosts = [...posts]
                .map(p => ({
                    ...p,
                    engagement: p.views > 0 ? ((p.likes + p.comments) / p.views * 100) : 0
                }))
                .sort((a, b) => b.views - a.views)
                .slice(0, 5);

            const maxViews = Math.max(...sortedPosts.map(p => p.views), 1);
            const tbody = document.querySelector('#topPostsTable tbody');
            tbody.innerHTML = '';

            sortedPosts.forEach(post => {
                const creator = creators.find(c => c.id === post.creatorId);
                const perfPercent = (post.views / maxViews) * 100;
                let perfClass = 'perf-low';
                if (perfPercent > 66) perfClass = 'perf-high';
                else if (perfPercent > 33) perfClass = 'perf-medium';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${creator?.name || ' 注'}</td>
                    <td><span class="platform-badge platform-${creator?.platform || ''}">${creator?.platform || '-'}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.caption || '-'}</td>
                    <td>${formatNumber(post.views)}</td>
                    <td>${formatNumber(post.likes)}</td>
                    <td>${formatNumber(post.comments)}</td>
                    <td>
                        <div class="performance">
                            <div class="performance-bar">
                                <div class="performance-fill ${perfClass}" style="width: ${perfPercent}%"></div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ API / WEBHOOK ============
        document.getElementById('apiTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('apiTestInput').value;

            try {
                const data = JSON.parse(input);
                const result = processApiData(data);

                document.getElementById('apiResponse').style.display = 'block';
                document.getElementById('apiResponseContent').textContent = JSON.stringify(result, null, 2);

                if (result.success) {
                    showToast('转 拽 爪');
                    loadCreators();
                    loadStatsHistory();
                    loadPosts();
                }
            } catch (error) {
                document.getElementById('apiResponse').style.display = 'block';
                document.getElementById('apiResponseContent').textContent = JSON.stringify({
                    success: false,
                    error: 'Invalid JSON: ' + error.message
                }, null, 2);
                showToast('砖 驻专 JSON', 'error');
            }
        });

        function processApiData(payload) {
            const { type, data } = payload;

            if (!type || !data) {
                return { success: false, error: 'Missing type or data field' };
            }

            const creators = DB.get('creators');
            let creator = creators.find(c =>
                c.handle.toLowerCase() === data.creatorHandle?.toLowerCase() ||
                c.handle.toLowerCase() === data.handle?.toLowerCase()
            );

            // Auto-create creator if not exists
            if (!creator && (data.creatorHandle || data.handle)) {
                creator = {
                    id: generateId(),
                    name: data.creatorName || data.creatorHandle || data.handle,
                    handle: data.creatorHandle || data.handle,
                    platform: data.platform || 'instagram',
                    category: data.category || '',
                    isActive: true
                };
                creators.push(creator);
                DB.set('creators', creators);
            }

            if (!creator) {
                return { success: false, error: 'Creator not found and could not be created' };
            }

            if (type === 'daily_stats') {
                const stats = DB.get('dailyStats');
                stats.push({
                    id: generateId(),
                    creatorId: creator.id,
                    date: data.date || new Date().toISOString().split('T')[0],
                    followersCount: data.followersCount || 0,
                    postsCount: data.postsCount || 0,
                    viewsToday: data.viewsToday || 0,
                    likesToday: data.likesToday || 0
                });
                DB.set('dailyStats', stats);
                return { success: true, message: 'Daily stats saved', creatorId: creator.id };
            }

            if (type === 'post') {
                const posts = DB.get('posts');
                posts.push({
                    id: generateId(),
                    creatorId: creator.id,
                    date: data.date || new Date().toISOString().split('T')[0],
                    platformPostId: data.platformPostId || '',
                    url: data.url || '',
                    caption: data.caption || '',
                    views: data.views || 0,
                    likes: data.likes || 0,
                    comments: data.comments || 0
                });
                DB.set('posts', posts);
                return { success: true, message: 'Post saved', creatorId: creator.id };
            }

            return { success: false, error: 'Unknown type. Use "daily_stats" or "post"' };
        }

        // ============ EXPORT/IMPORT ============
        function exportData(type) {
            let data;
            let filename;

            switch(type) {
                case 'creators':
                    data = DB.get('creators');
                    filename = 'emma-creators.json';
                    break;
                case 'stats':
                    data = DB.get('dailyStats');
                    filename = 'emma-stats.json';
                    break;
                case 'posts':
                    data = DB.get('posts');
                    filename = 'emma-posts.json';
                    break;
                case 'all':
                    data = {
                        creators: DB.get('creators'),
                        dailyStats: DB.get('dailyStats'),
                        posts: DB.get('posts'),
                        exportDate: new Date().toISOString()
                    };
                    filename = 'emma-full-export.json';
                    break;
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showToast('转 爪 爪');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.creators && data.dailyStats && data.posts) {
                        // Full import
                        if (confirm(' 专住 转  转 拽?')) {
                            DB.set('creators', data.creators);
                            DB.set('dailyStats', data.dailyStats);
                            DB.set('posts', data.posts);
                        }
                    } else if (Array.isArray(data)) {
                        // Partial import - try to detect type
                        if (data[0]?.handle) {
                            const existing = DB.get('creators');
                            DB.set('creators', [...existing, ...data]);
                        } else if (data[0]?.followersCount !== undefined) {
                            const existing = DB.get('dailyStats');
                            DB.set('dailyStats', [...existing, ...data]);
                        } else if (data[0]?.caption !== undefined) {
                            const existing = DB.get('posts');
                            DB.set('posts', [...existing, ...data]);
                        }
                    }

                    loadCreators();
                    loadStatsHistory();
                    loadPosts();
                    showToast('转  爪');
                } catch (error) {
                    showToast('砖 拽专转 拽抓', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ============ GOOGLE SHEETS SYNC ============
        function saveGoogleSheetsUrl() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (!url) {
                showToast(' 转转 转拽', 'error');
                return;
            }
            const settings = DB.getSettings();
            settings.googleSheetsUrl = url;
            DB.setSettings(settings);
            showToast('转转 Google Sheets 砖专');
        }

        function toggleAutoSync() {
            const autoSync = document.getElementById('autoSync').checked;
            const settings = DB.getSettings();
            settings.autoSync = autoSync;
            DB.setSettings(settings);
            showToast(autoSync ? '住专  驻注' : '住专  ');
        }

        async function testGoogleSheetsConnection() {
            const settings = DB.getSettings();
            const url = settings.googleSheetsUrl || document.getElementById('googleSheetsUrl').value;

            if (!url) {
                showToast(' 转转 Google Sheets 拽', 'error');
                return;
            }

            showSyncStatus('拽 专...', 'loading');

            try {
                const response = await fetch(url + '?action=creators');
                if (!response.ok) throw new Error('HTTP ' + response.status);

                const data = await response.json();
                if (Array.isArray(data)) {
                    showSyncStatus(` 专 转拽! 爪 ${data.length} 爪专`, 'success');
                    showToast('专 转拽!');
                } else {
                    showSyncStatus('锔 转砖  爪驻 砖专转', 'warning');
                }
            } catch (error) {
                showSyncStatus(` 砖: ${error.message}`, 'error');
                showToast('砖 专', 'error');
            }
        }

        async function syncFromGoogleSheets() {
            const settings = DB.getSettings();
            const url = settings.googleSheetsUrl || document.getElementById('googleSheetsUrl').value;

            if (!url) {
                showToast(' 转转 Google Sheets 拽', 'error');
                return;
            }

            showSyncStatus(' 住专 转 -Google Sheets...', 'loading');

            try {
                const response = await fetch(url + '?action=all');
                if (!response.ok) throw new Error('HTTP ' + response.status);

                const data = await response.json();

                let stats = {
                    creators: 0,
                    dailyStats: 0,
                    posts: 0
                };

                // 住专 爪专
                if (data.creators && Array.isArray(data.creators)) {
                    const existingCreators = DB.get('creators');
                    const existingIds = new Set(existingCreators.map(c => c.id));

                    data.creators.forEach(creator => {
                        if (!existingIds.has(creator.id)) {
                            existingCreators.push(creator);
                            stats.creators++;
                        } else {
                            // 注 爪专 拽
                            const idx = existingCreators.findIndex(c => c.id === creator.id);
                            if (idx !== -1) {
                                existingCreators[idx] = { ...existingCreators[idx], ...creator };
                            }
                        }
                    });
                    DB.set('creators', existingCreators);
                }

                // 住专 住住拽转 转
                if (data.dailyStats && Array.isArray(data.dailyStats)) {
                    const existingStats = DB.get('dailyStats');
                    const existingKeys = new Set(existingStats.map(s => `${s.creatorId}_${s.date}`));

                    data.dailyStats.forEach(stat => {
                        const key = `${stat.creatorId}_${stat.date}`;
                        if (!existingKeys.has(key)) {
                            existingStats.push(stat);
                            stats.dailyStats++;
                        }
                    });
                    DB.set('dailyStats', existingStats);
                }

                // 住专 驻住
                if (data.posts && Array.isArray(data.posts)) {
                    const existingPosts = DB.get('posts');
                    const existingIds = new Set(existingPosts.map(p => p.id));

                    data.posts.forEach(post => {
                        if (!existingIds.has(post.id)) {
                            existingPosts.push(post);
                            stats.posts++;
                        }
                    });
                    DB.set('posts', existingPosts);
                }

                // 专注 转爪
                loadCreators();
                loadStatsHistory();
                loadPosts();

                const statusMsg = ` 住专 砖!

 住:
 爪专 砖: ${stats.creators}
 住住拽转 砖转: ${stats.dailyStats}
 驻住 砖: ${stats.posts}
 注 专: ${data.lastUpdate || new Date().toISOString()}`;

                showSyncStatus(statusMsg, 'success');
                showToast('住专 砖 爪!');

            } catch (error) {
                console.error('Sync error:', error);
                showSyncStatus(` 砖 住专: ${error.message}`, 'error');
                showToast('砖 住专', 'error');
            }
        }

        function showSyncStatus(message, type) {
            const container = document.getElementById('syncStatus');
            const content = document.getElementById('syncStatusContent');
            container.style.display = 'block';
            content.textContent = message;
            content.style.whiteSpace = 'pre-wrap';

            // 爪注 驻 住
            if (type === 'loading') {
                container.style.borderColor = 'var(--warning)';
            } else if (type === 'success') {
                container.style.borderColor = 'var(--success)';
            } else if (type === 'error') {
                container.style.borderColor = 'var(--danger)';
            }
        }

        // ============ AI REPORT ============
        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function saveApiKey() {
            const key = document.getElementById('geminiApiKey').value;
            const settings = DB.getSettings();
            settings.geminiApiKey = key;
            DB.setSettings(settings);
            showToast('驻转 API 砖专');
        }

        async function generateEmmaReport() {
            const creators = DB.get('creators');
            const stats = DB.get('dailyStats');
            const posts = DB.get('posts');

            if (creators.length === 0 || stats.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('emmaReportContainer').style.display = 'none';
                return;
            }

            const settings = DB.getSettings();
            const apiKey = settings.geminiApiKey || document.getElementById('geminiApiKey').value;

            // Prepare data summary
            const dataSummary = prepareDataSummary(creators, stats, posts);

            document.getElementById('reportLoading').style.display = 'block';
            document.getElementById('emmaReportContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';

            try {
                let reportContent;

                if (apiKey) {
                    reportContent = await generateAIReport(apiKey, dataSummary);
                } else {
                    reportContent = generateLocalReport(dataSummary);
                }

                document.getElementById('emmaReportContent').textContent = reportContent;
                document.getElementById('emmaReportContainer').style.display = 'block';

                // Save to history
                const reports = DB.get('reports') || [];
                reports.unshift({
                    id: generateId(),
                    date: new Date().toISOString(),
                    content: reportContent
                });
                DB.set('reports', reports.slice(0, 10));
                loadReportsHistory();

            } catch (error) {
                console.error('Report generation error:', error);
                document.getElementById('emmaReportContent').textContent = generateLocalReport(dataSummary);
                document.getElementById('emmaReportContainer').style.display = 'block';
            }

            document.getElementById('reportLoading').style.display = 'none';
        }

        function prepareDataSummary(creators, stats, posts) {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            const weekStats = stats.filter(s => s.date >= weekAgo);
            const weekPosts = posts.filter(p => p.date >= weekAgo);

            // Top growing creators
            const growthData = creators.map(creator => {
                const creatorStats = stats.filter(s => s.creatorId === creator.id)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (creatorStats.length < 2) return { creator, growth: 0, percent: 0 };

                const first = creatorStats[0].followersCount;
                const last = creatorStats[creatorStats.length - 1].followersCount;
                const growth = last - first;
                const percent = first > 0 ? ((growth / first) * 100).toFixed(2) : 0;

                return { creator, growth, percent, latest: last };
            }).sort((a, b) => b.growth - a.growth);

            // Top posts
            const topPosts = [...posts]
                .sort((a, b) => b.views - a.views)
                .slice(0, 5)
                .map(p => {
                    const creator = creators.find(c => c.id === p.creatorId);
                    return { ...p, creatorName: creator?.name || 'Unknown' };
                });

            // Platform breakdown
            const platformStats = {};
            creators.forEach(c => {
                if (!platformStats[c.platform]) {
                    platformStats[c.platform] = { count: 0, totalFollowers: 0, totalViews: 0 };
                }
                platformStats[c.platform].count++;

                const latestStat = stats
                    .filter(s => s.creatorId === c.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                if (latestStat) {
                    platformStats[c.platform].totalFollowers += latestStat.followersCount;
                    platformStats[c.platform].totalViews += latestStat.viewsToday;
                }
            });

            return {
                totalCreators: creators.length,
                totalPosts: posts.length,
                weekPosts: weekPosts.length,
                growthData,
                topPosts,
                platformStats,
                date: today
            };
        }

        async function generateAIReport(apiKey, data) {
            const prompt = `转  专, 砖驻注转 AI 转 27 砖注专 专 砖注 转 .
转 爪转, , 专转 专 转  专  专.
住 砖: "转 转       注   拽砖 砖 拽, 砖  爪专   砖."

转 "   拽 砖 注 转 :

住" 爪专 转 注拽: ${data.totalCreators}
住" 驻住: ${data.totalPosts}
驻住 砖注: ${data.weekPosts}

驻 爪:
${data.growthData.slice(0, 3).map(g => `- ${g.creator.name}: +${formatNumber(g.growth)} 注拽 (${g.percent}%)`).join('\n')}

驻 驻住 驻 爪驻转:
${data.topPosts.map(p => `- ${p.creatorName}: ${formatNumber(p.views)} 爪驻转`).join('\n')}

驻驻专转:
${Object.entries(data.platformStats).map(([platform, stats]) =>
    `- ${platform}: ${stats.count} 爪专, ${formatNumber(stats.totalFollowers)} 注拽`
).join('\n')}

转 " 拽爪专 拽注 (3-5 驻住拽转) 注 转转 转, 驻, 转转.
砖转砖 砖驻 砖专, 注 爪转 注  转 注 注专 转.
住 注 "驻 砖 " - 砖 驻专拽 砖爪专 转  砖 .`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 1024
                    }
                })
            });

            const result = await response.json();

            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            }

            throw new Error('Invalid API response');
        }

        function generateLocalReport(data) {
            const topGrower = data.growthData[0];
            const topPost = data.topPosts[0];

            return `"   | ${data.date}

  砖  ? ${data.totalCreators} 爪专 转 注拽, ${data.totalPosts} 驻住 住.
,  住驻专转.   砖 注砖. 转 注 转转 砖 拽 住,  住驻专转 拽.

${topGrower ? `  砖 砖注: ${topGrower.creator.name}
爪 砖 ${formatNumber(topGrower.growth)} 注拽 (${topGrower.percent}%).
 住? 专 砖 砖 转 注拽, 拽 拽,  拽爪转  专转.
( 砖驻砖 拽 注拽.  专 , 专?)` : ''}

${topPost ? ` 驻住 :
${topPost.creatorName} 注 ${formatNumber(topPost.views)} 爪驻转.
${topPost.views > 100000 ? ', 砖 驻爪 转 专转.' : '住.  砖 拽 砖驻专.'}` : ''}

${Object.keys(data.platformStats).length > 0 ? `
驻驻专转:
${Object.entries(data.platformStats).map(([platform, stats]) =>
    ` ${platform}: ${stats.count} 爪专, ${formatNumber(stats.totalFollowers)} 注拽`
).join('\n')}` : ''}

---

 驻 砖 :
转驻住拽 专祝 专 专转. 转转 转 拽.
专转   拽拽 - 驻 专注  专.
拽   专转 专转 - 拽 ,  住祝 注 拽转.

砖,
 `;
        }

        function loadReportsHistory() {
            const reports = DB.get('reports') || [];
            const container = document.getElementById('reportsHistory');

            if (reports.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">"转 砖爪专 驻注 ...</p>';
                return;
            }

            container.innerHTML = reports.map(report => `
                <div class="emma-report" style="margin-bottom: 15px; cursor: pointer;" onclick="this.querySelector('.emma-content').style.display = this.querySelector('.emma-content').style.display === 'none' ? 'block' : 'none'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>" -${new Date(report.date).toLocaleDateString('he-IL')}</strong>
                        <small>爪 专</small>
                    </div>
                    <div class="emma-content" style="display: none; margin-top: 15px;">${report.content}</div>
                </div>
            `).join('');
        }

        // ============ INIT ============
        function init() {
            // Set default dates
            document.getElementById('statsDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('postDate').value = new Date().toISOString().split('T')[0];

            // Load saved settings
            const settings = DB.getSettings();

            // Load Gemini API key
            if (settings.geminiApiKey) {
                document.getElementById('geminiApiKey').value = settings.geminiApiKey;
            }

            // Load Google Sheets URL
            if (settings.googleSheetsUrl) {
                document.getElementById('googleSheetsUrl').value = settings.googleSheetsUrl;
            }

            // Load auto-sync setting
            if (settings.autoSync) {
                document.getElementById('autoSync').checked = true;
            }

            // Load all data
            loadCreators();
            loadStatsHistory();
            loadPosts();
            loadReportsHistory();

            // Add some demo data if empty
            if (DB.get('creators').length === 0) {
                addDemoData();
            }

            // Auto-sync from Google Sheets if enabled
            if (settings.autoSync && settings.googleSheetsUrl) {
                setTimeout(() => {
                    syncFromGoogleSheets();
                }, 1000);
            }
        }

        function addDemoData() {
            const demoCreators = [
                { id: 'demo1', name: '注 注砖', handle: '@adi_ayash', platform: 'instagram', category: '驻住', isActive: true },
                { id: 'demo2', name: '专 ', handle: '@nadir_eli', platform: 'tiktok', category: '专', isActive: true },
                { id: 'demo3', name: ' ', handle: '@liel_eli', platform: 'instagram', category: '驻', isActive: true },
                { id: 'demo4', name: ' 专专', handle: '@maya_wert', platform: 'youtube', category: '驻', isActive: true },
                { id: 'demo5', name: '拽 专', handle: '@kobi_adri', platform: 'tiktok', category: '拽', isActive: true }
            ];

            const today = new Date();
            const demoStats = [];
            const demoPosts = [];

            demoCreators.forEach((creator, idx) => {
                let followers = 50000 + Math.random() * 200000;

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);

                    followers += Math.random() * 5000 - 1000;

                    demoStats.push({
                        id: generateId(),
                        creatorId: creator.id,
                        date: date.toISOString().split('T')[0],
                        followersCount: Math.round(followers),
                        postsCount: 100 + idx * 20 + i,
                        viewsToday: Math.round(Math.random() * 50000),
                        likesToday: Math.round(Math.random() * 10000)
                    });
                }

                demoPosts.push({
                    id: generateId(),
                    creatorId: creator.id,
                    date: today.toISOString().split('T')[0],
                    platformPostId: 'demo_' + idx,
                    url: '',
                    caption: '驻住  - 转 拽专 砖 ' + creator.name,
                    views: Math.round(Math.random() * 500000),
                    likes: Math.round(Math.random() * 30000),
                    comments: Math.round(Math.random() * 2000)
                });
            });

            DB.set('creators', demoCreators);
            DB.set('dailyStats', demoStats);
            DB.set('posts', demoPosts);

            loadCreators();
            loadStatsHistory();
            loadPosts();
        }

        // Start
        init();
    </script>
</body>
</html>
