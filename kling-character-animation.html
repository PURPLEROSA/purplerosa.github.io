<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI.GOS - Kling AI Character Animation</title>
    <link rel="icon" type="image/jpeg" href="aigos.jpg">
    <link rel="apple-touch-icon" href="aigos.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --dark: #0f0a1a;
            --darker: #050208;
            --light: #f8fafc;
            --gray: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--darker);
            color: var(--light);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Background animation */
        .bg-orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-orbs .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: floatOrb 15s ease-in-out infinite;
        }

        .bg-orbs .orb:nth-child(1) {
            width: 400px;
            height: 400px;
            background: var(--primary);
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .bg-orbs .orb:nth-child(2) {
            width: 300px;
            height: 300px;
            background: var(--secondary);
            bottom: -50px;
            left: -50px;
            animation-delay: -5s;
        }

        .bg-orbs .orb:nth-child(3) {
            width: 250px;
            height: 250px;
            background: var(--accent);
            top: 50%;
            left: 50%;
            animation-delay: -10s;
        }

        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.1); }
            50% { transform: translate(-30px, 50px) scale(0.9); }
            75% { transform: translate(30px, 30px) scale(1.05); }
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            background: rgba(5, 2, 8, 0.8);
            backdrop-filter: blur(20px);
        }

        .header img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        /* Section cards */
        .card {
            background: rgba(15, 10, 26, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            transition: border-color 0.3s;
        }

        .card:hover {
            border-color: rgba(139, 92, 246, 0.35);
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
        }

        .card-title .icon {
            font-size: 1.4rem;
        }

        /* API Key input */
        .api-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .input-group label {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .input-group input, .input-group select, .input-group textarea {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: var(--light);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
            direction: ltr;
            text-align: left;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.15);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .input-group select {
            cursor: pointer;
        }

        .input-group select option {
            background: var(--dark);
        }

        /* Image upload area */
        .upload-area {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
        }

        .upload-area.has-image {
            border-style: solid;
            border-color: var(--success);
            padding: 0.5rem;
        }

        .upload-area .upload-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.6;
        }

        .upload-area .upload-text {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .upload-area img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 12px;
            object-fit: contain;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        /* Preview grid */
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        /* Prompt display */
        .prompt-box {
            background: rgba(139, 92, 246, 0.06);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            padding: 1rem;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            color: #c4b5fd;
            line-height: 1.8;
            direction: ltr;
            text-align: left;
            position: relative;
            white-space: pre-wrap;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 0.3rem 0.7rem;
            color: var(--light);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: var(--primary);
        }

        /* Camera controls visual */
        .camera-visual {
            background: rgba(6, 182, 212, 0.06);
            border: 1px solid rgba(6, 182, 212, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .camera-visual canvas {
            border-radius: 8px;
            margin: 0.5rem 0;
        }

        /* Settings grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        /* Camera sliders */
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .slider-group label {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
        }

        .slider-group label span {
            color: var(--accent);
            font-family: monospace;
        }

        .slider-group input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 3px;
            outline: none;
            direction: ltr;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
        }

        /* Generate button */
        .generate-btn {
            width: 100%;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .generate-btn .spinner {
            display: none;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .generate-btn.loading .spinner {
            display: block;
        }

        .generate-btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status / Progress */
        .status-bar {
            display: none;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .status-bar.visible {
            display: block;
        }

        .status-bar .status-text {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .status-bar .status-text.error {
            color: var(--error);
        }

        .status-bar .status-text.success {
            color: var(--success);
        }

        .progress-bar {
            height: 4px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            width: 0%;
            transition: width 0.5s;
            animation: progressPulse 2s ease-in-out infinite;
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Video result */
        .result-section {
            display: none;
        }

        .result-section.visible {
            display: block;
        }

        .video-container {
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        .video-container video {
            width: 100%;
            display: block;
            border-radius: 16px;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            color: var(--success);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-family: inherit;
        }

        .download-btn:hover {
            background: rgba(16, 185, 129, 0.25);
        }

        /* Open Kling button */
        .open-kling-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            color: var(--accent);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-family: inherit;
        }

        .open-kling-btn:hover {
            background: rgba(6, 182, 212, 0.25);
        }

        /* Steps instructions */
        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .step {
            background: rgba(139, 92, 246, 0.06);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .step-desc {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Tab switcher */
        .tab-switcher {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            color: var(--gray);
            cursor: pointer;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.3s;
            text-align: center;
        }

        .tab-btn.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary);
            color: var(--light);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(139, 92, 246, 0.12);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .preview-grid, .api-section, .settings-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }
        }

        /* Info badge */
        .info-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--warning);
            margin-top: 0.5rem;
        }

        /* Preset buttons */
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .preset-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: var(--light);
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .preset-btn:hover, .preset-btn.active {
            background: rgba(139, 92, 246, 0.25);
            border-color: var(--primary);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="bg-orbs">
        <div class="orb"></div>
        <div class="orb"></div>
        <div class="orb"></div>
    </div>

    <div class="header">
        <img src="aigos.jpg" alt="AI.GOS Logo">
        <h1>Kling AI Character Animation</h1>
    </div>

    <div class="container">
        <!-- Method Tabs -->
        <div class="tab-switcher">
            <button class="tab-btn active" onclick="switchTab('api')">API ישיר</button>
            <button class="tab-btn" onclick="switchTab('manual')">ממשק Kling AI</button>
        </div>

        <!-- API Key Section -->
        <div class="card" id="api-card">
            <div class="card-title">
                <span class="icon">&#128273;</span>
                הגדרות API - Kling AI
            </div>
            <div class="api-section">
                <div class="input-group">
                    <label>Access Key</label>
                    <input type="password" id="accessKey" placeholder="הכנס Access Key מ-Kling AI">
                </div>
                <div class="input-group">
                    <label>Secret Key</label>
                    <input type="password" id="secretKey" placeholder="הכנס Secret Key מ-Kling AI">
                </div>
            </div>
            <div class="info-badge" style="margin-top:1rem;">
                &#128161; ניתן להשיג מפתחות API מ-<a href="https://app.klingai.com/global/dev/api-key" target="_blank" style="color:var(--warning);text-decoration:underline;">Kling AI Developer Portal</a>
            </div>
        </div>

        <!-- Image Upload -->
        <div class="card">
            <div class="card-title">
                <span class="icon">&#128247;</span>
                תמונת הדמות
            </div>
            <div class="preview-grid">
                <div>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
                        <input type="file" id="imageInput" accept="image/*">
                        <div class="upload-icon">&#128228;</div>
                        <div class="upload-text">לחץ להעלאת תמונת הדמות<br>או גרור תמונה לכאן</div>
                    </div>
                </div>
                <div>
                    <div class="card-title" style="font-size:1rem;">
                        <span class="icon">&#127916;</span>
                        הגדרות אנימציה
                    </div>
                    <div class="input-group" style="margin-bottom:0.8rem;">
                        <label>פרומפט (תיאור האנימציה)</label>
                        <textarea id="promptText" rows="4">The character comes alive with dramatic cinematic movement, camera slowly orbiting around the character from the front, dense atmospheric smoke and haze billowing from behind, volumetric lighting cutting through the smoke, intense dramatic pose with flowing fabric and hair movement, epic cinematic atmosphere, 4K quality</textarea>
                    </div>
                    <div class="preset-buttons">
                        <button class="preset-btn active" onclick="setPreset('dramatic')">דרמטי + עשן</button>
                        <button class="preset-btn" onclick="setPreset('gentle')">עדין ואלגנטי</button>
                        <button class="preset-btn" onclick="setPreset('action')">אקשן</button>
                        <button class="preset-btn" onclick="setPreset('mystical')">מיסטי</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera & Video Settings -->
        <div class="card">
            <div class="card-title">
                <span class="icon">&#127909;</span>
                הגדרות מצלמה ווידאו
            </div>
            <div class="settings-grid">
                <div class="input-group">
                    <label>מודל</label>
                    <select id="modelSelect">
                        <option value="kling-v2-master">Kling v2 Master (מומלץ)</option>
                        <option value="kling-v1-6">Kling v1.6 Pro</option>
                        <option value="kling-v1-5">Kling v1.5 Pro</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>משך (שניות)</label>
                    <select id="durationSelect">
                        <option value="5">5 שניות</option>
                        <option value="10" selected>10 שניות</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>מצב</label>
                    <select id="modeSelect">
                        <option value="pro" selected>Pro (איכות גבוהה)</option>
                        <option value="std">Standard (מהיר)</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:1.2rem;">
                <div class="card-title" style="font-size:1rem;">
                    <span class="icon">&#127903;</span>
                    שליטה במצלמה
                </div>
                <div class="settings-grid">
                    <div class="slider-group">
                        <label>Pan (סיבוב אופקי) <span id="panVal">-15</span></label>
                        <input type="range" id="panSlider" min="-45" max="45" value="-15" oninput="updateSlider('pan')">
                    </div>
                    <div class="slider-group">
                        <label>Tilt (סיבוב אנכי) <span id="tiltVal">5</span></label>
                        <input type="range" id="tiltSlider" min="-45" max="45" value="5" oninput="updateSlider('tilt')">
                    </div>
                    <div class="slider-group">
                        <label>Zoom (התקרבות) <span id="zoomVal">3</span></label>
                        <input type="range" id="zoomSlider" min="-10" max="10" value="3" oninput="updateSlider('zoom')">
                    </div>
                    <div class="slider-group">
                        <label>Horizontal (תזוזה צדדית) <span id="horizontalVal">10</span></label>
                        <input type="range" id="horizontalSlider" min="-45" max="45" value="10" oninput="updateSlider('horizontal')">
                    </div>
                    <div class="slider-group">
                        <label>Vertical (תזוזה אנכית) <span id="verticalVal">0</span></label>
                        <input type="range" id="verticalSlider" min="-45" max="45" value="0" oninput="updateSlider('vertical')">
                    </div>
                    <div class="slider-group">
                        <label>Roll (גלגול) <span id="rollVal">0</span></label>
                        <input type="range" id="rollSlider" min="-45" max="45" value="0" oninput="updateSlider('roll')">
                    </div>
                </div>
            </div>

            <div class="input-group" style="margin-top:1rem;">
                <label>Negative Prompt</label>
                <input type="text" id="negativePrompt" value="blur, distortion, low quality, static, frozen, watermark, text" dir="ltr">
            </div>
        </div>

        <!-- Generate Button -->
        <button class="generate-btn" id="generateBtn" onclick="generateVideo()">
            <span class="btn-text">&#9889; ייצר סרטון אנימציה</span>
            <div class="spinner"></div>
        </button>

        <!-- Status bar -->
        <div class="status-bar" id="statusBar">
            <div class="status-text" id="statusText">מאתחל...</div>
            <div class="progress-bar">
                <div class="fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Result -->
        <div class="result-section card" id="resultSection">
            <div class="card-title">
                <span class="icon">&#127916;</span>
                תוצאה - סרטון אנימציה
            </div>
            <div class="video-container">
                <video id="resultVideo" controls autoplay loop></video>
            </div>
            <div style="display:flex;gap:1rem;flex-wrap:wrap;">
                <a class="download-btn" id="downloadBtn" download="kling-animation.mp4">
                    &#11015; הורד סרטון
                </a>
                <button class="open-kling-btn" onclick="generateVideo()">
                    &#128260; ייצר שוב
                </button>
            </div>
        </div>

        <!-- Manual Tab Content -->
        <div class="tab-content" id="manualTab">
            <div class="card">
                <div class="card-title">
                    <span class="icon">&#128218;</span>
                    שימוש ב-Kling AI דרך הדפדפן
                </div>
                <p style="color:var(--gray);margin-bottom:1rem;">
                    אם אין לך מפתחות API, תוכל להשתמש ב-Kling AI ישירות דרך הממשק שלהם. הנה השלבים:
                </p>
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-title">פתח את Kling AI</div>
                        <div class="step-desc">לחץ על הכפתור למטה לפתיחת ממשק Kling AI</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-title">בחר Image to Video</div>
                        <div class="step-desc">בחר במצב Image to Video וטען את תמונת הדמות</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-title">הדבק את הפרומפט</div>
                        <div class="step-desc">העתק והדבק את הפרומפט המוכן מלמעלה</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-title">הגדר מצלמה</div>
                        <div class="step-desc">הפעל Camera Control ובחר Orbit / Custom</div>
                    </div>
                </div>

                <div style="margin-top:1.5rem;">
                    <div class="card-title" style="font-size:1rem;">
                        <span class="icon">&#128203;</span>
                        פרומפט מוכן להעתקה
                    </div>
                    <div class="prompt-box" id="manualPromptBox">
                        <button class="copy-btn" onclick="copyPrompt()">&#128203; העתק</button>
The character comes alive with dramatic cinematic movement, camera slowly orbiting around the character from the front, dense atmospheric smoke and haze billowing from behind, volumetric lighting cutting through the smoke, intense dramatic pose with flowing fabric and hair movement, epic cinematic atmosphere, 4K quality</div>
                </div>

                <div style="margin-top:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;">
                    <a class="open-kling-btn" href="https://app.klingai.com/global/ai-video/generate" target="_blank">
                        &#127760; פתח Kling AI (Image to Video)
                    </a>
                    <a class="open-kling-btn" href="https://app.klingai.com/global/quickstart/ai-camera-control-guide" target="_blank">
                        &#128247; מדריך Camera Control
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ State ============
        let uploadedImageBase64 = null;
        let uploadedImageFile = null;
        let currentTab = 'api';
        let pollInterval = null;

        // ============ Tab Switching ============
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && tab === 'api') || (i === 1 && tab === 'manual'));
            });
            document.getElementById('api-card').classList.toggle('hidden', tab === 'manual');
            document.getElementById('manualTab').classList.toggle('hidden', tab !== 'manual');
            document.getElementById('manualTab').style.display = tab === 'manual' ? 'block' : 'none';
            document.getElementById('generateBtn').classList.toggle('hidden', tab === 'manual');
        }

        // ============ Image Upload ============
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');

        imageInput.addEventListener('change', handleImageSelect);
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--primary)'; });
        uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '';
            if (e.dataTransfer.files.length) {
                imageInput.files = e.dataTransfer.files;
                handleImageSelect({ target: imageInput });
            }
        });

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            uploadedImageFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                uploadedImageBase64 = ev.target.result;
                uploadArea.innerHTML = `<img src="${ev.target.result}" alt="Character">`;
                uploadArea.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        // ============ Presets ============
        const presets = {
            dramatic: {
                prompt: 'The character comes alive with dramatic cinematic movement, camera slowly orbiting around the character from the front, dense atmospheric smoke and haze billowing from behind, volumetric lighting cutting through the smoke, intense dramatic pose with flowing fabric and hair movement, epic cinematic atmosphere, 4K quality',
                pan: -15, tilt: 5, zoom: 3, horizontal: 10, vertical: 0, roll: 0
            },
            gentle: {
                prompt: 'The character gently sways with elegant subtle movement, soft breeze flowing through hair and clothing, camera slowly gliding around from the front with a graceful arc, soft bokeh lights in the background, dreamy atmospheric glow, smooth cinematic motion, ethereal and beautiful, 4K quality',
                pan: -8, tilt: 3, zoom: 2, horizontal: 5, vertical: 2, roll: 0
            },
            action: {
                prompt: 'The character bursts into dynamic action pose, explosive energy with debris and particles flying, camera rapidly orbiting around from the front, dramatic speed lines and motion blur, intense battle-ready stance, powerful wind effects on clothing, thunderous cinematic impact, 4K quality',
                pan: -25, tilt: 8, zoom: 5, horizontal: 15, vertical: -3, roll: 3
            },
            mystical: {
                prompt: 'The character channels mystical energy, glowing magical particles and ethereal smoke swirling around, camera orbiting from the front revealing magical aura, enchanted atmosphere with floating light orbs, mysterious dark fog behind, supernatural dramatic lighting, fantasy cinematic quality, 4K',
                pan: -12, tilt: 4, zoom: 2, horizontal: 8, vertical: 3, roll: -2
            }
        };

        function setPreset(name) {
            const p = presets[name];
            document.getElementById('promptText').value = p.prompt;
            document.getElementById('manualPromptBox').textContent = p.prompt;

            ['pan', 'tilt', 'zoom', 'horizontal', 'vertical', 'roll'].forEach(key => {
                document.getElementById(key + 'Slider').value = p[key];
                document.getElementById(key + 'Val').textContent = p[key];
            });

            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes({
                    dramatic: 'דרמטי',
                    gentle: 'עדין',
                    action: 'אקשן',
                    mystical: 'מיסטי'
                }[name]));
            });
        }

        // ============ Sliders ============
        function updateSlider(name) {
            const val = document.getElementById(name + 'Slider').value;
            document.getElementById(name + 'Val').textContent = val;
        }

        // ============ Copy Prompt ============
        function copyPrompt() {
            const text = document.getElementById('promptText').value;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '✓ הועתק!';
                setTimeout(() => { btn.innerHTML = '&#128203; העתק'; }, 2000);
            });
        }

        // ============ JWT Generation ============
        async function generateJWT(accessKey, secretKey) {
            // JWT Header
            const header = { alg: 'HS256', typ: 'JWT' };

            // JWT Payload
            const now = Math.floor(Date.now() / 1000);
            const payload = {
                iss: accessKey,
                exp: now + 1800,
                nbf: now - 5,
                iat: now
            };

            function base64UrlEncode(obj) {
                const str = typeof obj === 'string' ? obj : JSON.stringify(obj);
                const base64 = btoa(unescape(encodeURIComponent(str)));
                return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }

            const encodedHeader = base64UrlEncode(header);
            const encodedPayload = base64UrlEncode(payload);
            const signingInput = encodedHeader + '.' + encodedPayload;

            // HMAC-SHA256 signing
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secretKey);
            const cryptoKey = await crypto.subtle.importKey(
                'raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
            );
            const signatureBuffer = await crypto.subtle.sign('HMAC', cryptoKey, encoder.encode(signingInput));
            const signatureArray = new Uint8Array(signatureBuffer);
            let signatureBase64 = btoa(String.fromCharCode(...signatureArray));
            signatureBase64 = signatureBase64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

            return signingInput + '.' + signatureBase64;
        }

        // ============ Show Status ============
        function showStatus(text, type = 'info', progress = -1) {
            const bar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');

            bar.classList.add('visible');
            statusText.textContent = text;
            statusText.className = 'status-text' + (type !== 'info' ? ` ${type}` : '');

            if (progress >= 0) {
                progressFill.style.width = progress + '%';
            }
        }

        function hideStatus() {
            document.getElementById('statusBar').classList.remove('visible');
        }

        // ============ Image to Base64 for API ============
        function getImageBase64ForAPI() {
            if (!uploadedImageBase64) return null;
            // Remove data URL prefix
            const base64 = uploadedImageBase64.split(',')[1];
            return base64;
        }

        // ============ Generate Video ============
        async function generateVideo() {
            const accessKey = document.getElementById('accessKey').value.trim();
            const secretKey = document.getElementById('secretKey').value.trim();

            if (!accessKey || !secretKey) {
                showStatus('נא להזין Access Key ו-Secret Key. ניתן להשיג אותם מ-Kling AI Developer Portal.', 'error');
                return;
            }

            if (!uploadedImageBase64) {
                showStatus('נא להעלות תמונת דמות לפני יצירת הסרטון.', 'error');
                return;
            }

            const btn = document.getElementById('generateBtn');
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                // Generate JWT
                showStatus('מייצר טוקן אימות...', 'info', 5);
                const token = await generateJWT(accessKey, secretKey);

                // Build camera control config
                const cameraControl = {
                    type: 'simple',
                    config: {
                        horizontal: parseInt(document.getElementById('horizontalSlider').value),
                        vertical: parseInt(document.getElementById('verticalSlider').value),
                        pan: parseInt(document.getElementById('panSlider').value),
                        tilt: parseInt(document.getElementById('tiltSlider').value),
                        roll: parseInt(document.getElementById('rollSlider').value),
                        zoom: parseInt(document.getElementById('zoomSlider').value)
                    }
                };

                // Check if all camera values are 0
                const camValues = Object.values(cameraControl.config);
                const hasCamera = camValues.some(v => v !== 0);

                // Build request body
                const modelMap = {
                    'kling-v2-master': 'kling-v2-master',
                    'kling-v1-6': 'kling-v1-6',
                    'kling-v1-5': 'kling-v1-5'
                };

                const body = {
                    model_name: modelMap[document.getElementById('modelSelect').value] || 'kling-v2-master',
                    input: {
                        image: uploadedImageBase64,
                        prompt: document.getElementById('promptText').value,
                        negative_prompt: document.getElementById('negativePrompt').value,
                        duration: document.getElementById('durationSelect').value,
                        mode: document.getElementById('modeSelect').value
                    }
                };

                if (hasCamera) {
                    body.input.camera_control = cameraControl;
                }

                // Submit generation task
                showStatus('שולח בקשה ל-Kling AI... מייצר סרטון אנימציה', 'info', 15);

                const createResponse = await fetch('https://api.klingai.com/v1/videos/image2video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });

                if (!createResponse.ok) {
                    const errorData = await createResponse.json().catch(() => ({}));
                    throw new Error(`API Error ${createResponse.status}: ${errorData.message || errorData.msg || createResponse.statusText}`);
                }

                const createData = await createResponse.json();
                const taskId = createData.data?.task_id;

                if (!taskId) {
                    throw new Error('לא התקבל Task ID מהשרת. תשובה: ' + JSON.stringify(createData));
                }

                showStatus(`משימה נוצרה בהצלחה! Task ID: ${taskId}. ממתין ליצירת הסרטון...`, 'info', 25);

                // Poll for result
                await pollForResult(token, taskId);

            } catch (error) {
                showStatus(`שגיאה: ${error.message}`, 'error');
                console.error('Generation error:', error);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // ============ Poll for Result ============
        async function pollForResult(token, taskId) {
            const maxAttempts = 120; // 10 minutes max
            let attempts = 0;

            return new Promise((resolve, reject) => {
                if (pollInterval) clearInterval(pollInterval);

                pollInterval = setInterval(async () => {
                    attempts++;

                    if (attempts > maxAttempts) {
                        clearInterval(pollInterval);
                        reject(new Error('תם הזמן - הסרטון לא הושלם תוך 10 דקות'));
                        return;
                    }

                    const progress = Math.min(25 + (attempts / maxAttempts) * 70, 95);
                    showStatus(`מייצר סרטון... (${Math.floor(progress)}%) - ממתין לתוצאה...`, 'info', progress);

                    try {
                        const response = await fetch(`https://api.klingai.com/v1/videos/image2video/${taskId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (!response.ok) {
                            // Token might have expired, try to regenerate
                            if (response.status === 401) {
                                const accessKey = document.getElementById('accessKey').value.trim();
                                const secretKey = document.getElementById('secretKey').value.trim();
                                token = await generateJWT(accessKey, secretKey);
                                return; // Retry with new token
                            }
                            return; // Retry on other errors
                        }

                        const data = await response.json();
                        const status = data.data?.task_status;

                        if (status === 'succeed' || status === 'completed') {
                            clearInterval(pollInterval);

                            const videoUrl = data.data?.task_result?.videos?.[0]?.url
                                || data.data?.works?.[0]?.resource?.resource;

                            if (videoUrl) {
                                showResult(videoUrl);
                                showStatus('הסרטון נוצר בהצלחה!', 'success', 100);
                                resolve(videoUrl);
                            } else {
                                reject(new Error('הסרטון נוצר אבל לא נמצא URL. תשובה: ' + JSON.stringify(data)));
                            }
                        } else if (status === 'failed') {
                            clearInterval(pollInterval);
                            reject(new Error('יצירת הסרטון נכשלה: ' + (data.data?.task_status_msg || 'Unknown error')));
                        }
                        // Otherwise keep polling (processing/pending/submitted)
                    } catch (err) {
                        console.warn('Poll attempt error:', err);
                        // Keep polling on network errors
                    }
                }, 5000); // Poll every 5 seconds
            });
        }

        // ============ Show Result ============
        function showResult(videoUrl) {
            const resultSection = document.getElementById('resultSection');
            const video = document.getElementById('resultVideo');
            const downloadBtn = document.getElementById('downloadBtn');

            video.src = videoUrl;
            downloadBtn.href = videoUrl;
            resultSection.classList.add('visible');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ============ Initialize manual tab as hidden ============
        document.getElementById('manualTab').style.display = 'none';
    </script>
</body>
</html>
