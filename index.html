<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI.GOS Secret Engine</title>
    <link rel="icon" type="image/jpeg" href="aigos.jpg">
    <link rel="apple-touch-icon" href="aigos.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f5f5f7;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .logo {
            height: 80px;
            width: auto;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(255,105,180,0.2);
            animation: floatLogo 3s ease-in-out infinite;
        }

        .title {
            text-align: center;
            margin: 0;
            font-weight: 700;
            font-size: 2.5rem;
            background: linear-gradient(135deg, 
                #FF69B4,
                #FFD700
            );
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 
                0px 0px 1px rgba(0,0,0,0.3),
                0px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .title::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            z-index: -1;
            background: none;
            -webkit-text-fill-color: transparent;
            filter: blur(4px);
        }

        @keyframes floatLogo {
            0%, 100% { 
                transform: translateY(0) rotate(0deg); 
            }
            50% { 
                transform: translateY(-10px) rotate(2deg); 
            }
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* API Keys Section */
        .api-keys-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .api-key-input {
            flex: 1;
            position: relative;
        }

        .api-key-input label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .api-key-input input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid rgba(0, 122, 255, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .api-key-input input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        /* Upload Area */
        .upload-area {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(0, 122, 255, 0.3);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            border-color: #007AFF;
            background: rgba(255, 255, 255, 0.95);
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            display: none;
            margin: 1rem auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Analyze Button */
        .analyze-btn {
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 2rem 0;
            display: none;
            align-items: center;
            gap: 0.8rem;
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.2);
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 122, 255, 0.3);
        }

        .analyze-btn.analyzing {
            background: linear-gradient(-45deg, #007AFF, #00C7FF, #007AFF);
            background-size: 200% 200%;
            animation: gradient 1.5s ease infinite;
            pointer-events: none;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Loading Animation */
        .loading-container {
            text-align: center;
            margin: 2rem 0;
            display: none;
        }

        .loading-orb {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: linear-gradient(45deg, #007AFF, #00C7FF);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(0, 122, 255, 0.3);
        }

        /* Results Section */
        .result-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-content {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            position: relative;
            font-size: 1rem;
            line-height: 1.8;
            color: #444;
        }

        .copy-btn {
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: sticky;
            top: 1rem;
            float: right;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.8;
            z-index: 100;
        }

        .copy-btn:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 122, 255, 0.2);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #34C759, #30D158);
        }

        .copy-btn span {
            font-size: 1.1rem;
        }

        .copy-btn.copied::after {
            content: '✓';
            position: absolute;
            right: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Background Animation */
        .background-orbs {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(30px);
            opacity: 0.3;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
            100% { transform: translate(0, 0); }
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.5; }
        }

        .chat-section {
            margin-top: 2rem;
        }

        /* עיצוב מחדש של הצ'אט */
        .chat-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chat-messages {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* עיצוב הבועות */
        .chat-message {
            max-width: 80%;
            padding: 1rem 1.5rem;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .user-message {
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .assistant-message {
            background: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* כפתור העתקה */
        .chat-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: #666;
        }

        .assistant-message:hover .chat-copy-btn {
            opacity: 1;
        }

        .chat-copy-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .chat-copy-btn.copied {
            background: #34C759;
            color: white;
        }

        /* אזור הקלט */
        .chat-input-container {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            position: relative;
        }

        #chatInput, #refineInput {
            flex: 1;
            padding: 1rem;
            border: 1px solid rgba(0,122,255,0.3);
            border-radius: 15px;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            transition: all 0.3s ease;
        }

        #chatInput:focus, #refineInput:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
        }

        .chat-send-btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,122,255,0.3);
        }

        /* אנימציות */
        @keyframes messageAppear {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .prompts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .prompt-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: auto !important;
            min-height: 200px;
            margin-bottom: 2rem;
        }

        .prompt-card::-webkit-scrollbar {
            width: 8px;
        }

        .prompt-card::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .prompt-card::-webkit-scrollbar-thumb {
            background: rgba(0, 122, 255, 0.3);
            border-radius: 10px;
        }

        .prompt-card::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 122, 255, 0.5);
        }

        .prompt-card .copy-btn, .prompt-card .generate-btn {
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 1rem;
            background: rgba(0, 122, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: white;
        }

        .prompt-card .prompt-content {
            margin-top: 3rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .prompt-card h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #2563EB, #4F46E5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .prompts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 כרטיסיות בשורה */
            gap: 2rem;
            margin-top: 2rem;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
        }

        .analyzing-text span {
            display: inline-block;
            animation: bounce 0.3s ease infinite;
            animation-delay: calc(.1s * var(--i));
        }

        .analyzing-text span:nth-child(1) { --i: 1; }
        .analyzing-text span:nth-child(2) { --i: 2; }
        .analyzing-text span:nth-child(3) { --i: 3; }
        .analyzing-text span:nth-child(4) { --i: 4; }
        .analyzing-text span:nth-child(5) { --i: 5; }
        .analyzing-text span:nth-child(6) { --i: 6; }
        .analyzing-text span:nth-child(7) { --i: 7; }
        .analyzing-text span:nth-child(8) { --i: 8; }
        .analyzing-text span:nth-child(9) { --i: 9; }
        .analyzing-text span:nth-child(10) { --i: 10; }
        .analyzing-text span:nth-child(11) { --i: 11; }
        .analyzing-text span:nth-child(12) { --i: 12; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .section-content > div {
            margin-top: 3rem;
        }

        .typing-indicator {
            background: rgba(255, 255, 255, 0.9);
            margin-right: 2rem;
            padding: 1rem;
            border-radius: 10px;
            display: none;
        }

        .typing-animation {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #007AFF;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .message-sending {
            opacity: 0.5;
            transform: scale(0.98);
            transition: all 0.3s ease;
        }

        /* סגנונות לטיימר */
        .timer-container {
            position: relative;
            margin: 2rem auto;
            width: fit-content;
            z-index: 1;
            text-align: center;
            display: none;
        }

        .timer-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #007AFF ${progress}%)`;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .timer-circle::before {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
        }

        .timer-text {
            position: relative;
            z-index: 1;
            font-size: 1.5rem;
            font-weight: bold;
            color: #007AFF;
        }

        .timer-label {
            color: #666;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .prompt-content p,
        .prompt-content h3,
        .prompt-content ul,
        .prompt-content li {
            margin-bottom: 1rem;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .prompt-content {
            flex: 1;
            overflow-y: visible !important;
            padding-right: 1rem;
            margin-bottom: 1rem;
            white-space: pre-wrap !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.6;
            height: auto !important;
            max-height: none !important;
        }

        .copy-btn {
            position: sticky;
            bottom: 0;
            align-self: flex-end;
            margin-top: auto;
            z-index: 2;
        }

        /* עיצוב פס הגלילה */
        .prompt-content::-webkit-scrollbar {
            width: 6px;
        }

        .prompt-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .prompt-content::-webkit-scrollbar-thumb {
            background: rgba(0, 122, 255, 0.3);
            border-radius: 10px;
        }

        .prompt-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 122, 255, 0.5);
        }

        .mode-selection {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .mode-btn {
            background: var(--card-bg);
            border: none;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
            min-width: 200px;
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #FF69B4, #FFD700);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(255, 105, 180, 0.3);
        }

        .mode-btn span {
            font-size: 2rem;
        }

        .magic-wand-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem;
            justify-content: center;
        }

        .magic-wand-btn {
            background: linear-gradient(135deg, #FF69B4, #9370DB);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .magic-wand-btn.active {
            background: linear-gradient(135deg, #FF1493, #8A2BE2);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.5);
        }

        .wand-icon {
            font-size: 1.2rem;
        }

        .magic-status {
            font-size: 0.9rem;
            color: #FF69B4;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .magic-status.active {
            opacity: 1;
        }

        .title-container {
            text-align: center;
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .instagram-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: #FF69B4;
            font-size: 1.1rem;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            background: rgba(255, 105, 180, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .instagram-link:hover, 
        .instagram-link:focus {
            background: rgba(255, 105, 180, 0.15);
            transform: translateY(-2px);
            border-color: rgba(255, 105, 180, 0.3);
            box-shadow: 0 5px 15px rgba(255,105,180,0.2);
            outline: none;
        }

        .instagram-icon {
            font-size: 1.2rem;
        }

        @media (forced-colors: active) {
            .title {
                -webkit-text-fill-color: CanvasText;
                background: none;
            }
            
            .instagram-link {
                border: 2px solid CanvasText;
            }
        }

        /* Dark mode variables */
        :root {
            --bg-color: #f5f5f7;
            --text-color: #333;
            --card-bg: #fff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #fff;
            --card-bg: #2d2d2d;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            padding: 0.8rem;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: rgba(255, 105, 180, 0.1);
        }

        .theme-toggle:hover {
            background: rgba(255, 105, 180, 0.2);
            transform: translateY(-2px);
        }

        .theme-icon {
            font-size: 1.2rem;
        }

        /* עדכון צבעים לרכיבים קיימים */
        [data-theme="dark"] .prompt-card {
            background: var(--card-bg);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        [data-theme="dark"] .chat-container {
            background: var(--card-bg);
        }

        [data-theme="dark"] .api-key-input input {
            background: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .upload-area {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .magic-formula-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid rgba(255, 105, 180, 0.2);
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.1);
        }

        .magic-formula-content {
            display: flex;
            align-items: center;
            gap: 2rem;
            justify-content: space-between;
        }

        .magic-formula-text {
            flex: 1;
        }

        .magic-formula-text h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #FF69B4, #FFD700);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .magic-formula-text p {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .magic-preview {
            width: 200px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.2);
            transition: transform 0.3s ease;
        }

        .magic-preview:hover {
            transform: scale(1.05);
        }

        /* עיצוב המתג */
        .magic-switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 34px;
        }

        .magic-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 34px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }

        .slider:before {
            content: '';
            position: absolute;
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
            z-index: 2;
        }

        .slider .on,
        .slider .off {
            color: white;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
        }

        .slider .on {
            display: none;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #FF69B4, #FFD700);
        }

        input:checked + .slider:before {
            transform: translateX(46px);
        }

        input:checked + .slider .on {
            display: block;
        }

        input:checked + .slider .off {
            display: none;
        }

        [data-theme="dark"] .magic-formula-container {
            background: rgba(0, 0, 0, 0.2);
        }

        /* עיצוב הבועות */
        .chat-message {
            max-width: 80%;
            padding: 1rem 1.5rem;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .user-message {
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .assistant-message {
            background: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* כפתור העתקה */
        .chat-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: #666;
        }

        .assistant-message:hover .chat-copy-btn {
            opacity: 1;
        }

        .chat-copy-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .chat-copy-btn.copied {
            background: #34C759;
            color: white;
        }

        /* אזור הקלט */
        .chat-input-container {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            position: relative;
        }

        #chatInput, #refineInput {
            flex: 1;
            padding: 1rem;
            border: 1px solid rgba(0,122,255,0.3);
            border-radius: 15px;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            transition: all 0.3s ease;
        }

        #chatInput:focus, #refineInput:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
        }

        .chat-send-btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,122,255,0.3);
        }

        /* אנימציות */
        @keyframes messageAppear {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* יצוב אזור הרפיין */
        .refine-container {
            margin-top: 2rem;
            padding: 1rem;
        }

        .refine-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .refine-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid rgba(0,122,255,0.3);
            border-radius: 20px;
            font-size: 0.95rem;
            resize: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
        }

        .refine-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
        }

        .refine-typing-indicator {
            display: none;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
        }

        .prompt-card .generate-btn {
            background-color: black;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
        }

        /* סגנונות לאנימציית טעינה */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .image-loading-wrapper {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .image-loading-animation {
            text-align: center;
        }

        .pulse {
            width: 40px;
            height: 40px;
            background: rgba(0,122,255,0.2);
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .generating-text {
            color: #666;
            font-size: 0.9rem;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        /* סגנונות לגלריית התמונות */
        .generated-images-gallery {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .image-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .image-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        /* עיצוב כפתורי העולה בתמונה */
        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .image-card:hover .image-actions {
            transform: translateY(0);
        }

        .action-btn {
            padding: 0.5rem 1.2rem;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.5);
            background: linear-gradient(135deg, #0066CC, #00A3FF);
        }

        .action-btn span {
            font-size: 1.1rem;
        }

        .model-tag {
            background: rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
            border-radius: 15px;
            font-size: 0.8rem;
            color: #666;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* אנימציית טעינה */
        .loading-card {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-messages {
            font-size: 1.1rem;
            color: #333;
        }

        .loading-message {
            opacity: 0;
            animation: fadeInOut 4s infinite;
        }

        /* עיצוב כפתור Generate בסגנון אחיד */
        .vision-output .generate-btn {
            background: linear-gradient(45deg, #000000, #333333);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .vision-output .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* אנימציית טעינה חדשה */
        .loading-animation-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .loading-icon {
            animation: pulse 2s infinite;
        }

        .loading-icon svg {
            width: 48px;
            height: 48px;
            color: #fff;
        }

        .loading-messages {
            font-size: 1.1rem;
            color: #fff;
            min-height: 1.5em;
        }

        .current-message {
            animation: fadeInOut 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* מיקום הגלריה */
        .generated-images-gallery {
            order: -1;
            margin: 2rem 0;
            position: relative;
            z-index: 1;
        }

        /* כפתור Generate בהודעות Refine */
        .generate-refined-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(45deg, #000000, #333333);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .generate-refined-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .generate-refined-btn .icon {
            width: 18px;
            height: 18px;
        }

        /* אנימציית טעינה משופרת */
        .loading-animation-card {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .prompt-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .prompt-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .prompt-modal-content h3 {
            margin-bottom: 1rem;
        }

        .prompt-modal-content button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .model-tag {
            background: rgba(0,0,0,0.1);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
        }

        .section-content .generate-btn {
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            box-shadow: 0 5px 15px rgba(0, 122, 255, 0.3);
            position: sticky;
            top: 1rem;
            float: right;
            margin-left: 1rem;
            z-index: 100;
        }

        .section-content .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.4);
            background: linear-gradient(135deg, #0066CC, #00A3FF);
        }

        .section-content .generate-btn span {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-container">
            <img src="aigos.jpg" alt="AI.GOS Logo" class="logo">
            <h1 class="title">Shelly Or Gisser's Secret AI Engine</h1>
            <div class="header-actions">
                <a href="https://www.instagram.com/ai.gos" target="_blank" class="instagram-link" aria-label="Follow AI.GOS on Instagram">
                    <span class="instagram-icon">📸</span>
                    @ai.gos
                </a>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon">🌙</span>
                </button>
            </div>
        </div>
        
        <div class="api-keys-container">
            <div class="api-key-input">
                <label for="visionKey">Google Vision Pro 1.5 Model API Key</label>
                <input type="password" id="visionKey" placeholder="Enter Vision API Key">
                <button class="toggle-visibility" onclick="toggleVisibility('visionKey')">️</button>
            </div>
            <div class="api-key-input">
                <label for="llmKey">Cohere Command-R-Plus LLM Model API Key</label>
                <input type="password" id="llmKey" placeholder="Enter LLM API Key">
                <button class="toggle-visibility" onclick="toggleVisibility('llmKey')">👁️</button>
            </div>
            <div class="api-key-input">
                <label for="togetherKey">Together AI API Key</label>
                <input type="password" id="togetherKey" placeholder="Enter Together AI API Key">
                <button class="toggle-visibility" onclick="toggleVisibility('togetherKey')">👁️</button>
            </div>
        </div>

        <div class="mode-selection">
            <button class="mode-btn" onclick="selectMode('image')">
                <span>📸</span>
                Upload Image
            </button>
            <button class="mode-btn" onclick="selectMode('chat')">
                <span>💬</span>
                Chat for Ideas
            </button>
        </div>

        <div id="imageMode" class="mode-container" style="display: none;">
            <div class="upload-area" id="dropZone">
                <p>Drop your image here or click to upload</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>

            <img id="preview" class="preview-image">
            
            <button id="analyzeBtn" class="analyze-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Analyze Image
            </button>
        </div>

        <div id="chatMode" class="mode-container" style="display: none;">
            <div class="magic-formula-container">
                <!-- תוכן הנוסחה הקסומה -->
            </div>
            <div class="chat-container">
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <textarea id="chatInput" placeholder="Type your message..."></textarea>
                    <button onclick="sendChatMessage()" class="chat-send-btn">Send</button>
                </div>
                <div id="typingIndicator" class="typing-indicator" style="display: none;">
                    <div class="typing-animation">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="background-orbs">
            <div class="orb" style="background: #007AFF; width: 300px; height: 300px; top: 10%; left: 10%;"></div>
            <div class="orb" style="background: #00C7FF; width: 200px; height: 200px; bottom: 20%; right: 20%;"></div>
        </div>

        <div id="loading" class="loading-container">
            <div class="loading-orb"></div>
            <div class="loading-text">Processing your image...</div>
        </div>

        <div id="result" class="result-container">
            <div class="section">
                <h2 class="section-title">
                    <span>📸</span> Vision Description
                </h2>
                <div class="section-content">
                    <button class="copy-btn" onclick="copyToClipboard('visionOutput')">
                        <span>📋</span> Copy
                    </button>
                    <button class="generate-btn" onclick="generateImage('visionOutput')">
                        <span>🎨</span> Generate
                    </button>
                    <div id="visionOutput"></div>
                </div>
            </div>

            <div class="prompts-section">
                <h2 class="section-title">
                    <span>✨</span> Generated Prompts
                </h2>
                <div class="prompts-grid">
                    <div class="prompt-card">
                        <h3>Cinematic Style</h3>
                        <div id="promptOutput1" class="prompt-content"></div>
                        <div class="card-actions">
                            <button class="copy-btn" onclick="copyToClipboard('promptOutput1')">Copy</button>
                            <button class="generate-btn" onclick="generateImage('promptOutput1')">Generate</button>
                        </div>
                    </div>
                    <div class="prompt-card">
                        <h3>Dramatic Style</h3>
                        <div id="promptOutput2" class="prompt-content"></div>
                        <div class="card-actions">
                            <button class="copy-btn" onclick="copyToClipboard('promptOutput2')">Copy</button>
                            <button class="generate-btn" onclick="generateImage('promptOutput2')">Generate</button>
                        </div>
                    </div>
                    <div class="prompt-card">
                        <h3>Artistic Style</h3>
                        <div id="promptOutput3" class="prompt-content"></div>
                        <div class="card-actions">
                            <button class="copy-btn" onclick="copyToClipboard('promptOutput3')">Copy</button>
                            <button class="generate-btn" onclick="generateImage('promptOutput3')">Generate</button>
                        </div>
                    </div>
                    <div class="prompt-card">
                        <h3>Shelly's Magic Style</h3>
                        <div id="promptOutput4" class="prompt-content"></div>
                        <div class="card-actions">
                            <button class="copy-btn" onclick="copyToClipboard('promptOutput4')">Copy</button>
                            <button class="generate-btn" onclick="generateImage('promptOutput4')">Generate</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-section">
                <h2 class="section-title">
                    <span>💬</span> Refine Prompts
                </h2>
                <div class="chat-container">
                    <div id="refineMessages" class="chat-messages"></div>
                    <div id="refineTypingIndicator" class="typing-indicator" style="display: none;">
                        <div class="typing-animation">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <textarea id="refineInput" placeholder="Ask for prompt variations..."></textarea>
                        <button onclick="sendRefineMessage()" class="chat-send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="timer-container" id="timerContainer">
            <div class="timer-circle">
                <div class="timer-text">0%</div>
            </div>
            <div class="timer-label">Analyzing Image...</div>
        </div>

        <div class="magic-formula-container">
            <div class="magic-formula-content">
                <div class="magic-formula-text">
                    <h3>Shelly's Secret Magic</h3>
                    <p><b>Turn me on to get MIND BLOWING SHELLY EFFECT 🤯</b></p>
                    <label class="magic-switch">
                        <input type="checkbox" id="magicToggle" onchange="toggleMagicFormula()">
                        <span class="slider">
                            <span class="on">ON</span>
                            <span class="off">OFF</span>
                        </span>
                    </label>
                    <div id="magicStatus" class="magic-status"></div>
                </div>
                <img src="aigoseffect.png" alt="Magic Formula Effect Example" class="magic-preview">
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const visionOutput = document.getElementById('visionOutput');
        const promptOutput = document.getElementById('promptOutput');

        // Load saved API keys
        document.getElementById('visionKey').value = localStorage.getItem('visionKey') || '';
        document.getElementById('llmKey').value = localStorage.getItem('llmKey') || '';
        document.getElementById('togetherKey').value = localStorage.getItem('togetherKey') || '';

        // Save API keys on change
        ['visionKey', 'llmKey', 'togetherKey'].forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                localStorage.setItem(id, e.target.value);
            });
        });

        // Toggle API key visibility
        function toggleVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // File Upload Handlers
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#007AFF';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = 'rgba(0, 122, 255, 0.3)';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'rgba(0, 122, 255, 0.3)';
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    analyzeBtn.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        }

        // Vision Analysis Prompt
        function getVisionPrompt() {
            return `Analyze this image with professional photography and cinematography expertise:

1. 📷 Technical Analysis
   • Camera angle and position
   • Framing techniques used
   • Depth of field characteristics
   • Focal length indicators

2. 💡 Lighting Study
   • Main light sources and types
   • Lighting pattern (Rembrandt, Loop, etc.)
   • Shadow characteristics
   • Color temperature analysis

3. 🎨 Visual Elements
   • Color palette and harmony
   • Composition techniques
   • Texture and patterns
   • Mood and atmosphere

4. 🎬 Cinematic Elements
   • Movement and dynamics
   • Visual storytelling elements
   • Post-processing indicators
   • Special effects or treatments

${isMagicFormulaActive ? "\nIMPORTANT: Please incorporate and emphasize 'iridescent holographic scales and shimmer pastel color' in the analysis and suggestions.\n" : ""}

       In addition, here are few examples of such successful prompts - this is how i want the prompt to look like:

    1. REALISTIC IMAGE long shot of a forest scene featuring a unique hybrid creature, blending the head of a majestic deer with the powerful body of a tiger, entirely covered in iridescent scales. The creature's antlers stretch elegantly, shimmering with intricate, reflective scales that display a captivating array of holographic colors like purple, blue, and hints of bright green, now contrasted against a darker, more foreboding background. Its body, resembling a tiger's muscular form, moves stealthily through the forest, blending the majesty of the deer with the predatory grace of a tiger. The atmosphere is tense and dark, with a dark blue fog in the background, shadows playing across the scene and giving the environment a haunting, surreal quality.

    2. A mystical forest scene features a unique hybrid creature, blending the head of a majestic deer with the powerful body of a tiger, entirely covered in shimmering, iridescent scales and soft, pastel fur. The creature's antlers stretch elegantly, glowing with a soft pink hue, adding a magical touch to its presence. The scales and fur reflect an array of pastel colors, including light blue, lavender, and soft pink, creating a mesmerizing, dreamlike effect. The forest is bathed in ethereal light, with tall, shadowy trees and lush, delicate vegetation that includes coral-like structures and soft moss, enhancing the surreal atmosphere. Gentle bokeh effects float through the air, adding a sense of enchantment and tranquility. The overall composition captures a perfect blend of nature and fantasy, presenting the creature as a mythical guardian of this serene, spectral forest.

    3. A mystical forest scene features a unique hybrid creature, blending the head of a tiger with the muscular body of a tiger. The creature is covered in iridescent scales that shimmer in pastel colors, reflecting light blues, purples, and subtle hints of pink, creating a mesmerizing and ethereal effect. The forest is bathed in soft, magical light, with tall, shadowy trees and lush vegetation that includes coral-like structures and delicate moss, enhancing the surreal and dreamlike atmosphere. Gentle bokeh effects float through the air, adding a touch of enchantment and tranquility to the scene. The overall composition captures a harmonious blend of nature and fantasy, presenting this hybrid as a mythical guardian of the serene, spectral forest.

    4. An immersive atmospheric shot in a fantasy universe, featuring Lady Gaga with long blonde hair, wearing a dazzling, futuristic outfit composed of a sparkling, metallic bodysuit with shorts made of silver and holographic materials that shimmer under the street lights. On the belt of the suit, a logo "AI.GOS" is embroidered in purple. The bodysuit features sharp, structured shoulders that add a bold, dramatic flair, with long, tightly-fitted sleeves emphasizing her figure. The material is intricately adorned with sequins or mirrored embellishments, creating a kaleidoscopic effect of colors like blue, purple, and silver. The bodysuit is cinched at the waist with a matching belt, beautifully embroidered in deep purple, standing out just enough to catch the light and add a unique branding element without detracting from the overall shimmer and holographic effect of the outfit, enhancing her silhouette. The bottom part is styled as high-waisted shorts, leaving her legs exposed. She wears fishnet stockings that add an edgy touch to the glamorous ensemble. Her knee-high boots perfectly match the bodysuit, crafted from the same reflective, holographic fabric. The boots are pointed, with high heels, and reach just below her knees, completing the cohesive, eye-catching look. They have a sleek, fitted design with a slight slouch at the top, and the mirrored material continues to reflect the street lights, amplifying the outfit's dazzling effect. Adding a personalized touch, the side of the bodysuit subtly enhances the futuristic design. The entire ensemble exudes a bold, futuristic vibe, combining elements of glamour, performance, and avant-garde fashion, making the performer stand out vividly against the stage backdrop.

        here are examples of Camera Angles and Definitions

    Framing What's included and excluded in an individual shot.
    Extreme wide shot
    A shot in which figures appear small in the
    landscape. Often used at the beginning of a
    film or sequence as an 'establishing shot' to
    show where the action is taking place. Can
    also be used to make a person appear
    isolated or small.

    Wide Shot
    A shot in which a figure can be seen from
    head to toe. (tighter than an extreme wide
    shot)
    Mid Shot
    Shows the figure from approximately head to
    waist. In a mid shot, you can easily recognize
    an individual but you can also see what they
    are doing with their hands.
    Close-up
    Head and shoulders, enabling you to easily
    see facial expressions, which gives the
    audience a better impression of what your
    characters are thinking and feeling.
    Extreme close-up
    From just above the eyebrows to just below
    the mouth, or even closer: used to emphasize
    facial expression or to make the subject
    appear threatening.

    Over-the-Shoulder Shot
    A shot in which we see a character or main
    object over another's shoulder, often used in
    interviews or dialogues.
    Depth of field - This refers to how much of
    the shot seems to be in focus, in front of and
    behind the subject.
    Two Shot
    Any shot with two people in it.

    Here are lighting styles and definitions:

    Ambient Lighting
    Light that is present in a scene. This could be sunshine or an artificial light source such as a bulb. Flash lighting is not ambient, as it refers to pre-existing lighting not added by the photographer.

    

    Artificial Lighting
    Artificial lighting is a source of light that is anything apart from the sun – an natural source of light. This could include a household bulb or a flash.

    

    Broad Light
    A style of lighting that only illuminates the closest side of a face in a portrait. The word broad refers to the largest portion of the face that is visible to the camera. The opposite side to broad is narrow lighting.

    

    Back Light / Silhouetting
    When a light is placed behind a subject to only illuminates the outline creating a silhouette. Little detail is visible on the near side of the subject with backlighting.

    

    Butterfly Lighting
    A light placed above the camera and angled towards the subject. The lighting creates a slight shadow underneath the nose of the subject in the loose shape of a butterfly. It is a very flattering form of light championed by the Hollywood actress Marlene Dietrich which is why you may also hear it called 'Dietrich Lighting'.

    Continuous Lighting
    A light that doesn't flash, it continuously illuminates the subject until it is turned off or blocked out. A common household bulb or the sun is an example of continuous light.

    

    Colour Temperature
    All lights emit at different temperatures which affects the colour of that light. This temperature scale is referred to as the Kelvin scale (K). Household bulbs and candles emit around 2500K producing warm, orange lighting.

    Bright blue skies are much cooler and emit bluer tones around 9000K. Daylight balanced lighting is approximately 5500K which casts neither warm or cool tones, it appears closer to a white light.

    

    Catchlights
    A small reflection of a light source seen in the eye of a subject in a portrait. Catchlights are important to give shape, increase colour and make your subject look more energised.

    

    Clamshell Lighting
    The use of two matching light sources; one placed above the camera, the other below, both angled towards a subject. This 'clamshell' shape beautifies the face of the subject and the camera fits in between the gap of the lights.

    

    CTO / CTB
    Colour temperature orange (CTO) and colour temperature blue (CTB) are lighting gels that are used to counteract the colour temperature of certain lights. For lights that shine with warm colours a CTB gel is placed over the top to return it to a natural white tone.

    

    Deep Dish
    A common lighting modifier that fits over a strobe head in a photography studio. Normally silver-coated on the inside to bounce the light towards a subject. They can be deep or shallow depending upon the effect you require.

    

    Diffused Light
    Light that passes through a material to soften the strength and spread the light wider. Clouds are an example for diffusing sunshine.

    

    Drop Shadow
    The resulting shadow appears on the floor or a surface from using a hard light source.

    F-H
    Flash / Strobe Lighting
    A flash can either be built in/pop up in many digital cameras but is also available as a separate unit to use remotely. It is an electronically operated flash with adjustable power settings.

    

    Fill Light
    A light that is used to 'fill in' areas of shadow that is created by the main/key light. A reflector is sometimes used as 'fill light'.

    

    Flat
    Large black boards that stop the spread/spill of light back on to a subject. It is an accessory used to introduce negative fill.

    

    Gobo
    A shaped disc or sheet that is placed in front of a light to cast a patterned light/shadow. Used primarily in theatres for creating the effect of light passing through Venetian blinds for example.

    

    Guide Number
    The power of a digital flash unit dictates how far the light can reach. The higher the guide number (GN) the further the light can reach. All flashes have a manufacturer GN but this can be increased with higher ISO settings.

    

    Grids
    A type of modifier that attaches to the front of a softbox to help focus the diffused light onto a subject.

    

    Hard Light
    Light sources that demonstrate a short transition from light to shadow are referred to as 'hard'. The sun in a cloudless sky will produce heavy shadows like this.

    

    High Key Lighting
    A lighting style that focuses on large amount of light with very few shadows. This is the opposite to low key lighting.

    I-L
    Inverse Square Law
    A study that demonstrates the connection between the brightness and distance of a light source. Intensity or brightness will decrease at an inverse proportion to the square of a distance. Simply put, light drops off evenly over a given distance.

    

    Key / Main Light
    The primary light source that is being used in your photograph. This could be the sun, a flash or another light source. It is the one that is doing the most work to illuminate the subject.

    

    Loop Lighting
    A portrait lighting style is represented by a narrow gap of light along the cheek of a subject.

    

    Light Trails
    When a moving light passes through a shot using a slow shutter speed a trail of this motion can be left visible. Think of cars driving along a road a night and the red/white streaks of its tail/head lights streak across the shot.

    

    Lighting Gels
    A piece of semi-transparent plastic that colours the light source. The are available in a variety of colours and intensities.

    

    Low Key Lighting
    Photos are largely dark/shadow with very few highlights. Only one narrow light is used to illuminated so it doesn't spill onto the background. Think of film noir movies and dark movie posters.

    

    Lighting Ratio
    This is the exposure ratio between shadow and highlight. Having a high lighting ratio means you'll see a lot of contrast in your shot; while a low one means little/no contrast.

    Penumbra
    The area between shadow and highlight. A large penumbra means smooth gradient, a small one means hard light and no gradient.

    

    Qualities of Light
    There are 6 qualities of light to pay attention to as a photographer; Angle, Direction, Quantity, Distance, Colour and Size. Controlling these factors as a photographer will determine the look of your overall image.

    

    Rembrandt Lighting
    Named after the famous painter, a style of portrait lighting that is epitomised by an inverted triangle of light on the narrow side cheek of a subject.

    

    Reflector
    A surface that reflects/control the direction of a light source. Photography reflectors come in white (for neutral tone reflection), silver and gold.

    

    Ring Flash
    A modified flash unit that attached to either the camera's hot shoe or infront of your lens. Ring flash is use in macro photography to get light a subject without shadow or in a portrait leaving a donut shaped reflection in the eye.

    Split Lighting
    When light is only illuminating half of the subject there is a clear 'split' between light and shadow with a proportional balance. Split lighting can be achieved by positioning a light at the side of a subject.

    

    Soft Light
    Light that passes through a diffusing material to soften and spread the emitting light. Light from the sun that has passed through the clouds on an overcast day is soft light.

    

    Snoots
    A narrow conical-shaped lighting modifier that creates a narrow spotlight effect. Think of the iconic James Bond gun barrel point-of-view shot, this is similar to the effect of a snoot.

    

    Softbox
    A lighting modifier that softens the light from a flash or other continuous sources. It encompasses the light so there is no spill and all the available light is used.

    

    Spill
    The angle at which light spreads over an area. The angle can be narrowed by using modifiers such as barn doors to direct the path of the light.

    

    Types of Light
    There are 3 qualities of light that you will encounter – hard, soft and reflected.

    

    Umbrellas
    A classic example of a lighting modifier that can either be used to bounce light back into a scene or to be shot-through facing the subject.

    Now please provide the prompt that combines the image description and details on the camera angles and lightining.
    
Provide a comprehensive analysis that could serve as a blueprint for recreation.`;
        }

        // Analyze Button Handler
        analyzeBtn.addEventListener('click', async () => {
            analyzeBtn.classList.add('analyzing');
            analyzeBtn.innerHTML = `
                <div class="analyzing-text">
                    <span>A</span><span>n</span><span>a</span><span>l</span><span>y</span><span>z</span><span>i</span><span>n</span><span>g</span><span>.</span><span>.</span><span>.</span>
                </div>`;
            
            // קריאה לפונקציית הניתוח
            await analyzeImage();
        });

        // 1. פונקציית getMagicFormula - הגדרה בסיסית של הנוסחה
        function getMagicFormula() {
            return `((iridescent holographic scales and shimmer pastel color))`;
        }

        // עדכון פונקציית generatePrompt
        async function generatePrompt(description, llmKey, style) {
            const response = await fetch('https://api.cohere.ai/v1/generate', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${llmKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'command',
                    prompt: `Based on this image description: "${description}"

Create a detailed and comprehensive ${style} prompt. 
Your response MUST follow these rules:
1. Maximum length: 200 words exactly
2. Must include complete sentences
3. Must not end mid-sentence
4. Must maintain coherent structure
5. Must include all key visual elements
6. Focus on the most important details

Format your response with clear sections:
1. Scene Description (2-3 sentences)
2. Technical Details (2-3 sentences)
3. Visual Elements (2-3 sentences)
4. Mood and Atmosphere (2-3 sentences)

${isMagicFormulaActive ? "\nCRITICAL: Response MUST incorporate 'iridescent holographic scales and shimmer pastel color' as key visual elements.\n" : ""}

Keep the response concise but complete, exactly 200 words.`,
                    max_tokens: 350,
                    temperature: 0.8,
                    k: 0,
                    stop_sequences: [],
                    return_likelihoods: 'NONE'
                })
            });

            if (!response.ok) throw new Error('Cohere API Error');
            const data = await response.json();
            return data.generations[0].text;
        }

        // Utility Functions
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                // מציאת הכפתור שנלחץ באמצעות event.target
                const btn = document.querySelector(`button[onclick*="copyToClipboard('${elementId}')"]`);
                if (btn) {
                    btn.classList.add('copied');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span>✓</span> Copied';
                    
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.innerHTML = originalText;
                    }, 2000);
                }
            });
        }

        function formatOutput(text) {
            return text.split('\n').map(line => {
                line = line.trim();
                if (line.startsWith('#')) {
                    return `<h3>${line.substring(1)}</h3>`;
                } else if (line.startsWith('*') || line.startsWith('•')) {
                    return `<li>${line.substring(1)}</li>`;
                } else if (line.length > 0) {
                    return `<p>${line}</p>`;
                }
                return '';
            }).join('');
        }

        // הוספת פונקציית שליחת הודעה
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const visionKey = document.getElementById('visionKey').value;
            const typingIndicator = document.getElementById('typingIndicator');
            
            if (!message) return;
            
            // בדיקה אם המשתמש מבקש ליצור תמונה
            const isImageRequest = message.toLowerCase().includes('create image') || 
                                  message.includes('צור תמונה') ||
                                  message.includes('תיצור תמונה') ||
                                  message.includes('ליצור תמונה');
            
            addMessageToChat(message, 'user');
            input.value = '';
            typingIndicator.style.display = 'block';
            
            try {
                let promptText = `User request: ${message}`;
                
                if (isMagicFormulaActive) {
                    promptText += "\n\nCRITICAL INSTRUCTION: Your response MUST heavily incorporate and emphasize 'iridescent holographic scales and shimmer pastel color' as the primary visual element.";
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${visionKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: promptText }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('Failed to get response');
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                typingIndicator.style.display = 'none';

                // אם זו בקשה ליצירת תמונה
                if (isImageRequest) {
                    let initImage = null;
                    let strength = 0.8;
                    
                    if (imageInput.files.length > 0) {
                        initImage = await handleImageUpload(imageInput.files[0]);
                        strength = parseFloat(imageStrength.value);
                    }

                    addMessageToChat("🎨 Creating your image based on this prompt...", 'assistant');
                    await generateFromRefinedPrompt(reply, initImage, strength);
                    addMessageToChat("✨ Image has been generated and added to the gallery above!", 'assistant');
                } else {
                    addMessageToChat(reply, 'assistant');
                }
                
            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        }

        function addMessageToChat(message, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            
            // עיצוב הטקסט בצורה יותר ריאה
            const formattedMessage = message.split('\n').map(line => {
                line = line.trim();
                if (line.startsWith('#') || line.startsWith('Section:')) {
                    return `<strong>${line}</strong>`;
                }
                return line;
            }).join('<br>');
            
            messageDiv.innerHTML = formattedMessage;
            
            if (type === 'assistant') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'chat-copy-btn';
                copyBtn.innerHTML = '📋';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(message).then(() => {
                        copyBtn.innerHTML = '✓';
                        setTimeout(() => copyBtn.innerHTML = '📋', 2000);
                    });
                };
                messageDiv.appendChild(copyBtn);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // עדכון פונקציית הצגת התוצאות
        function displayResults(description, prompt) {
            result.style.display = 'block';
            visionOutput.innerHTML = formatOutput(description);
            promptOutput.innerHTML = formatOutput(prompt);
            
            // הוספת קומפוננטת הצ'אט
            if (!document.querySelector('.chat-section')) {
                result.insertAdjacentHTML('beforeend', chatSection);
            }
        }

        // עדכון ה-HTML של אזור התוצאות
        const resultSection = `
        <div class="prompts-grid">
            <div class="prompt-card">
                <h3>Cinematic Style</h3>
                <div id="promptOutput1" class="prompt-content"></div>
                <div class="card-actions">
                    <button class="copy-btn" onclick="copyToClipboard('promptOutput1')">Copy</button>
                    <button class="generate-btn" onclick="generateImage('promptOutput1')">Generate</button>
                </div>
            </div>
            <div class="prompt-card">
                <h3>Dramatic Style</h3>
                <div id="promptOutput2" class="prompt-content"></div>
                <div class="card-actions">
                    <button class="copy-btn" onclick="copyToClipboard('promptOutput2')">Copy</button>
                    <button class="generate-btn" onclick="generateImage('promptOutput2')">Generate</button>
                </div>
            </div>
            <div class="prompt-card">
                <h3>Artistic Style</h3>
                <div id="promptOutput3" class="prompt-content"></div>
                <div class="card-actions">
                    <button class="copy-btn" onclick="copyToClipboard('promptOutput3')">Copy</button>
                    <button class="generate-btn" onclick="generateImage('promptOutput3')">Generate</button>
                </div>
            </div>
            <div class="prompt-card">
                <h3>Shelly's Magic Style</h3>
                <div id="promptOutput4" class="prompt-content"></div>
                <div class="card-actions">
                    <button class="copy-btn" onclick="copyToClipboard('promptOutput4')">Copy</button>
                    <button class="generate-btn" onclick="generateImage('promptOutput4')">Generate</button>
                </div>
            </div>
        </div>`;

        // פונקציית לעדכון הטיימר
        function updateTimer(progress) {
            const timerCircle = document.querySelector('.timer-circle');
            const timerText = document.querySelector('.timer-text');
            
            timerCircle.style.background = `conic-gradient(from 0deg, #007AFF ${progress}%, transparent ${progress}%)`;
            timerText.textContent = `${Math.round(progress)}%`;
        }

        // עדכון פונקציית הניתוח
        async function analyzeImage() {
            const timerContainer = document.getElementById('timerContainer');
            timerContainer.style.display = 'block';
            let progress = 0;
            let isAnalyzing = true;
            let timerInterval;
            
            try {
                // Get API keys
                const visionKey = document.getElementById('visionKey').value;
                const llmKey = document.getElementById('llmKey').value;
                
                if (!visionKey || !llmKey) {
                    throw new Error('Please enter both Vision and LLM API keys');
                }

                if (!preview.src) {
                    throw new Error('Please upload an image first');
                }

                // Create dynamic vision prompt that includes magic formula if active
                const dynamicVisionPrompt = getVisionPrompt();

                // עדכון כפתור האנליזה למצב טעינה
                analyzeBtn.classList.add('analyzing');
                analyzeBtn.innerHTML = `
                    <div class="analyzing-text">
                        <span>A</span><span>n</span><span>a</span><span>l</span><span>y</span><span>z</span><span>i</span><span>n</span><span>g</span><span>.</span><span>.</span><span>.</span>
                    </div>`;
                
                timerInterval = setInterval(() => {
                    if (isAnalyzing && progress < 90) {
                        progress += 0.5;
                        updateTimer(progress);
                    }
                }, 50);

                const imageBase64 = preview.src.split(',')[1];
                
                // ניסיון לקבל את הניתוח עם מנגנון ניסיון חוזר
                const description = await getVisionAnalysis(imageBase64, visionKey);
                
                progress = 95;
                updateTimer(progress);
                
                // יצירת הפרמפים
                const prompts = await Promise.all([
                    generatePrompt(description, llmKey, "Create a cinematic prompt"),
                    generatePrompt(description, llmKey, "Create a dramatic prompt"),
                    generatePrompt(description, llmKey, "Create an artistic prompt"),
                    generatePrompt(description, llmKey, "Create a magic prompt")
                ]);
                
                // הצגת התוצאות
                document.getElementById('promptOutput1').innerHTML = formatOutput(prompts[0]);
                document.getElementById('promptOutput2').innerHTML = formatOutput(prompts[1]);
                document.getElementById('promptOutput3').innerHTML = formatOutput(prompts[2]);
                document.getElementById('promptOutput4').innerHTML = formatOutput(prompts[3]);
                visionOutput.innerHTML = formatOutput(description);
                
                progress = 100;
                updateTimer(progress);
                result.style.display = 'block';
                
                // שינוי כפתור האנליזה למצב הושלם
                analyzeBtn.classList.remove('analyzing');
                analyzeBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    Completed`;
                
                // החזרת הכפתור למצב הרגיל אחרי 3 שניות
                setTimeout(() => {
                    analyzeBtn.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Analyze Image`;
                }, 3000);
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
                
                // עדכון כפתור האנליזה למצב שגיאה
                analyzeBtn.classList.remove('analyzing');
                analyzeBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Error`;
                
                // החזרת הכפתור למצב הרגיל אחרי 3 שניות
                setTimeout(() => {
                    analyzeBtn.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Analyze Image`;
                }, 3000);
                
            } finally {
                isAnalyzing = false;
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                timerContainer.style.display = 'none';
            }
        }

        // פונקציית עזר לקבלת ניתוח מ-Gemini
        async function getGeminiAnalysis(imageBase64, visionKey) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${visionKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { inline_data: { mime_type: "image/jpeg", data: imageBase64 } },
                            { text: getVisionPrompt() }
                        ]
                    }]
                })
            });

            if (!response.ok) throw new Error('Gemini API Error');
            return response.json();
        }

        // פונקציית עזר לקבלת וריאציות פרומפט
        async function getPromptVariation(description, llmKey, style) {
            const response = await fetch('https://api.cohere.ai/v1/generate', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${llmKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'command',
                    prompt: `${style} based on this description: ${description}`,
                    max_tokens: 300,
                    temperature: 0.8,
                })
            });

            if (!response.ok) throw new Error('Cohere API Error');
            const data = await response.json();
            return data.generations[0].text;
        }

        // פונקציית הניתוח הראשית
        async function getVisionAnalysis(imageBase64, visionKey, retryCount = 3) {
            for (let i = 0; i < retryCount; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${visionKey}`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    {
                                        inline_data: {
                                            mime_type: "image/jpeg",
                                            data: imageBase64
                                        }
                                    },
                                    { text: getVisionPrompt() }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Vision API Error: ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();
                    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        throw new Error('Invalid response format from Vision API');
                    }

                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    
                    if (i === retryCount - 1) {
                        throw new Error(`Failed after ${retryCount} attempts: ${error.message}`);
                    }
                    
                    // המתנה לפני ניסיון נוסף
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        // הוספת מאזין לאירוע keypress
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

        function selectMode(mode) {
            // הסרת הקלאס active מכל הכפתורים
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // הוספת הקלאס active לכפתור הנבחר
            const selectedBtn = document.querySelector(`.mode-btn[onclick*="${mode}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }

            // הסתרת כל המודים
            document.querySelectorAll('.mode-container').forEach(container => {
                container.style.display = 'none';
                container.classList.remove('active');
            });
            
            // הצת המוד הנבחר
            const selectedContainer = document.getElementById(`${mode}Mode`);
            if (selectedContainer) {
                selectedContainer.style.display = 'block';
                
                // הוספת אנימציה
                setTimeout(() => {
                    selectedContainer.classList.add('active');
                }, 50);
            }
            
            // שמירת המוד הנבחר
            localStorage.setItem('selectedMode', mode);
        }

        // עדכון טעי��ת הדף
        document.addEventListener('DOMContentLoaded', () => {
            // הסתרת כל המודים בהתחלה
            document.querySelectorAll('.mode-container').forEach(container => {
                container.style.display = 'none';
                container.classList.remove('active');
            });
            
            // טעינת המוד השמור (אם קיים)
            const savedMode = localStorage.getItem('selectedMode');
            if (savedMode) {
                selectMode(savedMode);
            }
            
            // טעינת מצב הקסם רק אם נבחר מוד צ'אט
            const savedMagicState = localStorage.getItem('magicFormulaActive');
            if (savedMode === 'chat' && savedMagicState === 'true') {
                const toggle = document.getElementById('magicToggle');
                if (toggle) {
                    toggle.checked = true;
                    toggleMagicFormula();
                }
            }
        });

        // משתנים גלובליים
        let isMagicFormulaActive = false;
        let chatHistory = [];

        // Magic Formula Toggle Function
        function toggleMagicFormula() {
            const toggle = document.getElementById('magicToggle');
            const status = document.getElementById('magicStatus');
            isMagicFormulaActive = toggle.checked;
            
            status.textContent = isMagicFormulaActive ? '✨ Magic activated!' : '';
            status.classList.toggle('active', isMagicFormulaActive);
            
            localStorage.setItem('magicFormulaActive', isMagicFormulaActive);
        }

        // Load Magic Formula State
        document.addEventListener('DOMContentLoaded', () => {
            const savedMagicState = localStorage.getItem('magicFormulaActive');
            if (savedMagicState === 'true') {
                const toggle = document.getElementById('magicToggle');
                toggle.checked = true;
                toggleMagicFormula();
            }
        });

        // הוספת משתנה גלובלי לשמירת מצב התצוגה
        let currentTheme = localStorage.getItem('theme') || 'light';

        // עדכון פונקציית toggleTheme
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            
            // עדכון אייקון
            const themeIcon = document.querySelector('.theme-icon');
            themeIcon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
        }

        // הוספת מאזין לכפתו בטעינת הף
        document.addEventListener('DOMContentLoaded', () => {
            // אתחול מצב התצוגה
            document.documentElement.setAttribute('data-theme', currentTheme);
            const themeIcon = document.querySelector('.theme-icon');
            themeIcon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
            
            // הוספת מאזין לכפתור
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        });

        // עדכון פונקציית הרפיין
        async function refinePrompt() {
            const input = document.getElementById('refineInput');  // שינוי ל-ID במקום class
            const message = input.value.trim();
            if (!message) return;

            // הוספת ההודעה לצ'אט
            addMessageToChat(message, 'user', 'refineMessages');
            input.value = '';

            const typingIndicator = document.querySelector('.refine-typing-indicator');
            typingIndicator.style.display = 'flex';  // שינוי ל-flex במקו block

            try {
                const cohereKey = document.getElementById('llmKey').value;
                if (!cohereKey) throw new Error('Please enter your API key');

                let fullPrompt = `Based on the current image analysis and description, ${message}`;
                
                if (isMagicFormulaActive) {
                    fullPrompt += "\n\nPlease include 'iridescent holographic scales and shimmer pastel color' in your response.";
                }

                const response = await fetch('https://api.cohere.ai/v1/generate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${cohereKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'command',
                        prompt: fullPrompt,
                        max_tokens: 2048,
                        temperature: 0.8,
                        k: 0,
                        stop_sequences: [],
                        return_likelihoods: 'NONE'
                    })
                });

                if (!response.ok) throw new Error('Failed to get response');
                
                const data = await response.json();
                const reply = data.generations[0].text;
                
                typingIndicator.style.display = 'none';
                addMessageToChat(reply, 'assistant', 'refineMessages');
                
            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'assistant', 'refineMessages');
            }
        }

        // עדכון HTML של אזור הרפיין
        const refineSection = `
        <div class="refine-container">
            <h2 class="refine-title">💬 Refine Prompts</h2>
            <div class="chat-container">
                <div class="typing-indicator refine-typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <div id="refineMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <textarea class="refine-input" placeholder="Type your refinement request..."></textarea>
                    <button onclick="refinePrompt()" class="chat-send-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        `;

        // הוספת מאזין לאירוע keypress בשדה הקלט
        document.addEventListener('DOMContentLoaded', () => {
            const refineInput = document.querySelector('.refine-input');
            if (refineInput) {
                refineInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        refinePrompt();
                    }
                });
            }
        });

        // פונקציית שליחת הודעה לרפיין
        async function sendRefineMessage() {
            const input = document.getElementById('refineInput');
            const message = input.value.trim();
            const visionKey = document.getElementById('visionKey').value;
            const typingIndicator = document.getElementById('refineTypingIndicator');
            
            if (!message) return;
            
            addRefineMessage(message, 'user');
            input.value = '';
            typingIndicator.style.display = 'block';
            
            try {
                // בדיקה אם המשתמש מבקש ליצו�� תמונה
                const isImageRequest = message.toLowerCase().includes('create image') || 
                                     message.includes('צור תמונה') ||
                                     message.includes('תיצור תמונה') ||
                                     message.includes('ליצור תמונה');

                let promptText = `Based on this image and its analysis:
                    Current vision analysis: ${visionOutput.innerText}
                    
                    Current prompts:
                    1. ${document.getElementById('promptOutput1').innerText}
                    2. ${document.getElementById('promptOutput2').innerText}
                    3. ${document.getElementById('promptOutput3').innerText}
                    4. ${document.getElementById('promptOutput4').innerText}
                    
                    User request: ${message}`;

                if (isMagicFormulaActive) {
                    promptText += "\n\nPlease include 'iridescent holographic scales and shimmer pastel color' in your response and emphasise it strongly as it should be the main style of the generated image.";
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${visionKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: promptText }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('Failed to get response');
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                typingIndicator.style.display = 'none';

                // אם זו בקשה ליצירת תמונה
                if (isImageRequest) {
                    addRefineMessage("🎨 Creating your image based on this prompt...", 'assistant');
                    await generateFromRefinedPrompt(reply);
                    addRefineMessage("✨ Image has been generated and added to the gallery above!", 'assistant');
                } else {
                    addRefineMessage(reply, 'assistant');
                }
                
            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                addRefineMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        }

        // פונקציית הוספת ודעה לרפיין
        function addRefineMessage(message, type) {
            const chatMessages = document.getElementById('refineMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            messageDiv.textContent = message;
            
            if (type === 'assistant') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'chat-copy-btn';
                copyBtn.innerHTML = '📋';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(message).then(() => {
                        copyBtn.classList.add('copied');
                        setTimeout(() => copyBtn.classList.remove('copied'), 2000);
                    });
                };
                messageDiv.appendChild(copyBtn);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // הוספת מאזין לאירוע keypress בשדה הקלט של הרפיין
        document.addEventListener('DOMContentLoaded', () => {
            const refineInput = document.getElementById('refineInput');
            if (refineInput) {
                refineInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendRefineMessage();
                    }
                });
            }
        });

        // פונקציית יצירת תמונה
        async function generateImage(outputId) {
            const prompt = document.getElementById(outputId).innerText;
            const togetherKey = document.getElementById('togetherKey').value;
            
            if (!togetherKey) {
                alert('Please enter your Together AI API key');
                return;
            }

            // יצירת או קבלת הגלריה
            let gallery = document.querySelector('.generated-images-gallery');
            if (!gallery) {
                gallery = document.createElement('div');
                gallery.className = 'generated-images-gallery';
                document.querySelector('.prompts-grid').after(gallery);
            }

            // יצירת אנימציית טעינה
            const loadingCard = document.createElement('div');
            loadingCard.className = 'loading-card';
            loadingCard.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-messages">
                    <div class="loading-message">✨ Creating magical art just for you...</div>
                    <div class="loading-message">🎨 Blending colors and imagination...</div>
                    <div class="loading-message">💫 Adding that special AI.GOS touch...</div>
                </div>
            `;
            gallery.appendChild(loadingCard);

            try {
                let finalPrompt = prompt;
                if (isMagicFormulaActive) {
                    finalPrompt = `((iridescent holographic scales and shimmer pastel color)), ${prompt}, ((iridescent holographic scales and shimmer pastel color:1.5))`;
                }

                const response = await fetch('https://api.together.xyz/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${togetherKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "black-forest-labs/FLUX.1-schnell",
                        prompt: finalPrompt,
                        width: 1024,
                        height: 768,
                        steps: 4,
                        n: 1,
                        response_format: "b64_json"
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'API request failed');
                }

                const data = await response.json();
                loadingCard.remove();

                // יצירת כרטיס תמונה
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';
                
                const imageData = data.data[0].b64_json;
                const imageUrl = `data:image/jpeg;base64,${imageData}`;
                
                imageCard.innerHTML = `
                    <img src="${imageUrl}" alt="Generated Image">
                    <div class="image-actions">
                        <span class="model-tag">FLUX.1-schnell</span>
                        <button onclick="viewPrompt(\`${finalPrompt.replace(/`/g, '\\`')}\`)" class="action-btn">
                            <span>📝</span> View Prompt
                        </button>
                        <button onclick="downloadImage('${imageUrl}')" class="action-btn">
                            <span>⬇️</span> Download
                        </button>
                    </div>
                `;
                gallery.appendChild(imageCard);

            } catch (error) {
                console.error('Error generating image:', error);
                loadingCard.innerHTML = `
                    <div class="error-message">
                        Error generating image: ${error.message}
                    </div>
                `;
                setTimeout(() => loadingCard.remove(), 3000);
            }
        }

        // פונקציה להצגת הפרומפט
        function viewPrompt(prompt) {
            try {
                const modalContent = document.createElement('div');
                modalContent.className = 'prompt-modal';
                modalContent.innerHTML = `
                    <div class="prompt-modal-content">
                        <h3>Image Prompt</h3>
                        <div class="prompt-text">${prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        <button class="modal-close-btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                    </div>
                `;
                document.body.appendChild(modalContent);
            } catch (error) {
                console.error('Error displaying prompt:', error);
            }
        }

        // פונקציה להורדת התמונה
        function downloadImage(dataUrl) {
            if (!dataUrl || !dataUrl.startsWith('data:image')) {
                console.error('Invalid image URL');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `ai_gos_image_${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading image:', error);
                alert('Failed to download image');
            }
        }

        // משתנה גלובלי לשמירת הפרומפט האחרון מה-refine
        let lastRefinedPrompt = '';

        async function handleRefineResponse(assistantMessage) {
            // בודק אם ההודעה מכילה פרומפט חדש
            if (assistantMessage.includes('Prompt:') || assistantMessage.includes('prompt:')) {
                lastRefinedPrompt = assistantMessage;
                
                // הוספת כפתור Generate לתשובה
                const generateButton = document.createElement('button');
                generateButton.className = 'generate-refined-btn';
                generateButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 3v3m0 12v3M3 12h3m12 0h3m-9 0a3 3 0 110-6 3 3 0 010 6z"/>
                    </svg>
                    Generate Image
                `;
                generateButton.onclick = () => generateFromRefinedPrompt(lastRefinedPrompt);
                
                // הוספת הכפתור להודעה האחרונה
                const lastMessage = document.querySelector('.assistant-message:last-child');
                if (lastMessage) {
                    lastMessage.appendChild(generateButton);
                }
            }
        }

        async function generateFromRefinedPrompt(prompt, initImage = null, strength = 0.8) {
            prompt = prompt.replace(/Prompt:|prompt:/, '').trim();
            
            try {
                let gallery = document.querySelector('.generated-images-gallery');
                if (!gallery) {
                    gallery = document.createElement('div');
                    gallery.className = 'generated-images-gallery';
                    const chatContainer = document.querySelector('.chat-container');
                    if (chatContainer) {
                        chatContainer.parentNode.insertBefore(gallery, chatContainer);
                    } else {
                        document.querySelector('.container').appendChild(gallery);
                    }
                }

                // ... קוד הטעינה ...

                const response = await fetch('https://api.together.xyz/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('togetherKey').value}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "black-forest-labs/FLUX.1-schnell",
                        prompt: finalPrompt,
                        width: 1024,
                        height: 768,
                        steps: 4,
                        n: 1,
                        response_format: "b64_json",
                        init_image: initImage ? initImage : undefined,  // הוספת תמונת הרפרנס אם קיימת
                        image2image_strength: initImage ? strength : undefined  // הוספת עוצמת ההשפעה
                    })
                });

                const data = await response.json();
                loadingCard.remove();

                if (!data.data?.[0]?.b64_json) {
                    throw new Error('Invalid response from API');
                }

                const imageData = data.data[0].b64_json;
                const imageUrl = `data:image/jpeg;base64,${imageData}`;

                const imageWrapper = document.createElement('div');
                imageWrapper.className = 'image-card';
                imageWrapper.innerHTML = `
                    <img src="${imageUrl}" alt="Generated Image">
                    <div class="image-actions">
                        <span class="model-tag">FLUX.1-schnell</span>
                        <button onclick="viewPrompt(\`${finalPrompt.replace(/`/g, '\\`')}\`)" class="action-btn">
                            <span>📝</span> View Prompt
                        </button>
                        <button onclick="downloadImage('${imageUrl}')" class="action-btn">
                            <span>⬇️</span> Download
                        </button>
                    </div>
                `;
                
                gallery.appendChild(imageWrapper);

            } catch (error) {
                console.error('Error generating image:', error);
                alert('Failed to generate image: ' + error.message);
            }
        }

        // הוספת פונקציה לטיפול בהעלאת תמונה
        function handleImageUpload(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Image = e.target.result.split(',')[1];
                    resolve(base64Image);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
